<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2a2a2a">
    <title>Sermon</title>
    <link rel="stylesheet" href="../src/styles.css">
    <!-- Supabase JS Client (UMD Build) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.26.0/dist/umd/supabase.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #ffffff;
            color: #333;
            touch-action: manipulation;
        }

        body.dark-theme {
            background-color: #1a1a1a;
            color: #f0f0f0;
        }

        .sermon-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100%;
            background-color: #ffffff;
            transition: filter 0.3s ease;
        }

        .sermon-container.blurred {
            filter: blur(4px);
            pointer-events: none;
        }

        body.dark-theme .sermon-container {
            background-color: #1a1a1a;
        }

        /* Header styles matching Life of Jesus */
        .sermon-top-nav {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 16px;
            background: #2a2a2a;
            border-bottom: 1px solid #1f1f1f;
            position: sticky;
            top: 0;
            z-index: 100;
            margin: 0;
            transition: background 0.3s ease;
        }

        body.light-theme .sermon-top-nav {
            background: #f5f5f5;
            border-bottom: 1px solid #e0e0e0;
        }

        .sermon-back-btn,
        .sermon-add-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border: none;
            cursor: pointer;
            color: #ffffff;
            flex-shrink: 0;
            font-size: 20px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .sermon-back-btn {
            background: none;
        }

        .sermon-back-btn:hover {
            opacity: 0.8;
        }

        .sermon-back-btn:active {
            opacity: 0.6;
        }

        .sermon-add-btn {
            background: linear-gradient(135deg, #78aaff 0%, #5a94e6 100%);
            box-shadow: 0 4px 12px rgba(120, 170, 255, 0.4);
            transform: scale(1);
        }

        .sermon-add-btn:hover {
            background: linear-gradient(135deg, #8ab8ff 0%, #6ca4f6 100%);
            box-shadow: 0 6px 16px rgba(120, 170, 255, 0.5);
            transform: scale(1.1);
        }

        .sermon-add-btn:active {
            transform: scale(0.95);
            box-shadow: 0 2px 8px rgba(120, 170, 255, 0.3);
        }

        body.light-theme .sermon-back-btn {
            color: #333;
        }

        body.light-theme .sermon-add-btn {
            background: linear-gradient(135deg, #78aaff 0%, #5a94e6 100%);
            color: #ffffff;
            box-shadow: 0 4px 12px rgba(120, 170, 255, 0.4);
        }

        body.light-theme .sermon-add-btn:hover {
            background: linear-gradient(135deg, #8ab8ff 0%, #6ca4f6 100%);
            box-shadow: 0 6px 16px rgba(120, 170, 255, 0.5);
        }

        .sermon-back-btn svg,
        .sermon-add-btn svg {
            width: 24px;
            height: 24px;
        }

        .sermon-nav-title {
            font-size: 20px;
            font-weight: 600;
            color: #ffffff;
            margin: 0;
            flex: 1;
            white-space: nowrap;
            transition: opacity 0.2s ease;
        }

        body.light-theme .sermon-nav-title {
            color: #333;
        }

        .sermon-content {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            position: relative;
        }

        body.dark-theme .sermon-content {
            background-color: #1a1a1a;
        }

        /* Sermon loader styles */
        .sermon-loader-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #121212;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            flex-direction: column;
            gap: 20px;
        }

        .sermon-loader-wrapper.hidden {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease-out;
        }

        .sermon-loader-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #333333;
            border-top: 5px solid #ffffff;
            border-right: 5px solid #cccccc;
            border-radius: 50%;
            animation: sermon-spin 1s linear infinite;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
        }

        .sermon-loader-text {
            color: #cccccc;
            font-size: 16px;
            text-align: center;
            font-weight: 500;
            letter-spacing: 1px;
        }

        @keyframes sermon-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .sermon-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .sermon-item {
            padding: 1rem;
            border-radius: 8px;
            background: #f9f9f9;
            border: 1px solid #e0e0e0;
            transition: background 0.2s, box-shadow 0.2s;
            position: relative;
        }

        body.dark-theme .sermon-item {
            background: #252525;
            border-color: #3a3a3a;
        }

        .sermon-item:hover {
            background: #f3f3f3;
            box-shadow: 0 0 12px rgba(120, 170, 255, 0.3), inset 0 0 8px rgba(120, 170, 255, 0.1);
        }

        body.dark-theme .sermon-item:hover {
            background: #2d2d2d;
            box-shadow: 0 0 12px rgba(120, 170, 255, 0.4), inset 0 0 8px rgba(120, 170, 255, 0.15);
        }

        .sermon-item.active {
            background: #e8f0ff;
            border-color: #78aaff;
            box-shadow: 0 0 12px rgba(120, 170, 255, 0.4), inset 0 0 8px rgba(120, 170, 255, 0.15);
        }

        body.dark-theme .sermon-item.active {
            background: #1a2a40;
            border-color: #78aaff;
            box-shadow: 0 0 12px rgba(120, 170, 255, 0.4), inset 0 0 8px rgba(120, 170, 255, 0.15);
        }

        .sermon-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
        }

        .sermon-item-title-wrapper {
            flex: 1;
            min-width: 0; /* Important for flexbox text truncation */
        }

        .sermon-item-title {
            font-weight: 600;
            font-size: 0.9rem;
            margin: 0;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        body.dark-theme .sermon-item-title {
            color: #f0f0f0;
        }

        .sermon-date-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 4px 10px;
            background: rgba(0, 0, 0, 0.05);
            color: #999;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .sermon-date-icon {
            width: 14px;
            height: 14px;
            flex-shrink: 0;
        }

        body.dark-theme .sermon-date-badge {
            background: rgba(255, 255, 255, 0.05);
            color: #777;
        }

        .sermon-item-verses {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
            margin-top: 0.75rem;
        }

        .sermon-verse-item {
            display: flex;
            align-items: center;
        }

        .sermon-verse-badge {
            display: inline-block;
            padding: 6px 12px;
            background: rgba(120, 170, 255, 0.15);
            color: #78aaff;
            border: 1px solid rgba(120, 170, 255, 0.25);
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        body.dark-theme .sermon-verse-badge {
            background: rgba(120, 170, 255, 0.1);
            color: #8ab8ff;
            border-color: rgba(120, 170, 255, 0.2);
        }

        .passage-verse-badge {
            display: inline;
            padding: 0;
            background: none;
            color: #ff9800;
            border: none;
            border-radius: 0;
            font-size: inherit;
            font-weight: 600;
        }

        body.dark-theme .passage-verse-badge {
            background: none;
            color: #ffb74d;
            border-color: transparent;
        }

        .sermon-verse-more {
            display: inline-block;
            margin-left: 0.5rem;
            padding: 0 0;
            color: #999;
            font-size: 0.85rem;
            font-weight: 500;
        }

        body.dark-theme .sermon-verse-more {
            color: #777;
        }

        .sermon-verses-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .sermon-verse-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 6px 12px;
            background: rgba(120, 170, 255, 0.15);
            color: #78aaff;
            border: 1px solid rgba(120, 170, 255, 0.25);
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        body.dark-theme .sermon-verse-chip {
            background: rgba(120, 170, 255, 0.1);
            color: #8ab8ff;
            border-color: rgba(120, 170, 255, 0.2);
        }

        .sermon-verse-chip-remove {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0;
            line-height: 1;
            transition: opacity 0.2s;
        }

        .sermon-verse-chip-remove:hover {
            opacity: 0.7;
        }

        .sermon-dropdowns-container {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            overflow: visible;
        }

        .sermon-dropdowns-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            overflow: visible;
        }

        .sermon-dropdown-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            overflow: visible;
            flex: 1;
        }

        .sermon-verses-row {
            display: flex;
            gap: 0.75rem;
            align-items: flex-end;
            justify-content: space-between;
            position: relative;
            z-index: 1;
        }

        .sermon-verses-row .sermon-dropdown-group {
            flex: 0.8;
            min-width: 0;
        }

        .sermon-verses-row .sermon-add-verse-btn {
            flex-shrink: 0;
            margin-left: auto;
            margin-right: auto;
        }

        .sermon-dropdown-label {
            font-weight: 500;
            font-size: 0.85rem;
            color: #333;
        }

        body.dark-theme .sermon-dropdown-label {
            color: #f0f0f0;
        }

        .sermon-dropdown-select {
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 0.95rem;
            font-family: inherit;
            color: #333;
            background: #ffffff;
            cursor: pointer;
            transition: all 0.3s ease;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 40px;
            width: 100%;
        }

        .sermon-dropdown-select::placeholder,
        .sermon-dropdown-select option[value=""] {
            color: #bbb;
        }

        .sermon-dropdown-select option {
            padding: 10px;
            background: #ffffff;
            color: #333;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .sermon-dropdown-select option:checked {
            background: linear-gradient(#78aaff, #78aaff);
            color: #ffffff;
        }

        body.dark-theme .sermon-dropdown-select {
            background-color: #252525;
            border-color: #404040;
            color: #f0f0f0;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%23f0f0f0' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        }

        body.dark-theme .sermon-dropdown-select::placeholder,
        body.dark-theme .sermon-dropdown-select option[value=""] {
            color: #777;
        }

        body.dark-theme .sermon-dropdown-select option {
            background: #2a2a2a;
            color: #f0f0f0;
        }

        .sermon-dropdown-select:hover {
            border-color: #78aaff;
            box-shadow: 0 0 0 3px rgba(120, 170, 255, 0.1);
        }

        body.dark-theme .sermon-dropdown-select:hover {
            border-color: #78aaff;
            box-shadow: 0 0 0 3px rgba(120, 170, 255, 0.15);
        }

        .sermon-dropdown-select:focus {
            outline: none;
            border-color: #78aaff;
            box-shadow: 0 0 0 3px rgba(120, 170, 255, 0.2);
        }

        body.dark-theme .sermon-dropdown-select:focus {
            border-color: #78aaff;
            box-shadow: 0 0 0 3px rgba(120, 170, 255, 0.25);
        }

        .sermon-dropdown-select:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #f5f5f5;
        }

        body.dark-theme .sermon-dropdown-select:disabled {
            background-color: #1a1a1a;
        }

        .sermon-dropdown-select option {
            padding: 8px;
            background: #ffffff;
            color: #333;
        }

        body.dark-theme .sermon-dropdown-select option {
            background: #2a2a2a;
            color: #f0f0f0;
        }

        .sermon-dropdown-select[multiple] {
            min-height: 80px;
            padding: 6px;
            padding-right: 8px;
            background-image: none !important;
            background-position: none;
        }

        .sermon-dropdown-select[multiple] option {
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 4px;
            background: #ffffff;
            color: #333;
        }

        body.dark-theme .sermon-dropdown-select[multiple] option {
            background: #2a2a2a;
            color: #f0f0f0;
        }

        .sermon-dropdown-select[multiple] option:checked {
            background: linear-gradient(#78aaff, #78aaff);
            color: #ffffff;
            font-weight: 600;
        }

        /* Custom Dropdown Styles */
        .sermon-custom-dropdown-wrapper {
            position: relative;
            width: 100%;
            overflow: visible;
            z-index: 3000;
        }

        .sermon-custom-dropdown-button {
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 0.95rem;
            font-family: inherit;
            color: #333;
            background: #ffffff;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            text-align: left;
        }

        .sermon-custom-dropdown-button.placeholder {
            color: #bbb;
        }

        body.dark-theme .sermon-custom-dropdown-button.placeholder {
            color: #777;
        }

        body.dark-theme .sermon-custom-dropdown-button {
            background-color: #252525;
            border-color: #404040;
            color: #f0f0f0;
        }

        .sermon-custom-dropdown-button:hover {
            border-color: #78aaff;
            box-shadow: 0 0 0 3px rgba(120, 170, 255, 0.1);
        }

        body.dark-theme .sermon-custom-dropdown-button:hover {
            border-color: #78aaff;
            box-shadow: 0 0 0 3px rgba(120, 170, 255, 0.15);
        }

        .sermon-custom-dropdown-button.active {
            border-color: #78aaff;
            box-shadow: 0 0 0 3px rgba(120, 170, 255, 0.2);
        }

        .sermon-custom-dropdown-arrow {
            width: 20px;
            height: 20px;
            transition: transform 0.3s ease;
        }

        .sermon-custom-dropdown-button.active .sermon-custom-dropdown-arrow {
            transform: rotate(180deg);
        }

        .sermon-custom-dropdown-menu {
            position: fixed;
            background: #ffffff;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 9999;
            display: none;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        }

        body.dark-theme .sermon-custom-dropdown-menu {
            background: #2a2a2a;
            border-color: #404040;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        }

        .sermon-custom-dropdown-menu.active {
            display: block;
        }

        .sermon-custom-dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        body.dark-theme .sermon-custom-dropdown-item {
            border-bottom-color: #3a3a3a;
        }

        .sermon-custom-dropdown-item:last-child {
            border-bottom: none;
        }

        .sermon-custom-dropdown-item:hover {
            background: #f5f5f5;
        }

        body.dark-theme .sermon-custom-dropdown-item:hover {
            background: #333;
        }

        .sermon-custom-dropdown-item.selected {
            background: rgba(120, 170, 255, 0.1);
            color: #78aaff;
            font-weight: 600;
        }

        body.dark-theme .sermon-custom-dropdown-item.selected {
            background: rgba(120, 170, 255, 0.15);
            color: #8ab8ff;
        }

        .sermon-custom-dropdown-checkbox {
            width: 18px;
            height: 18px;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        body.dark-theme .sermon-custom-dropdown-checkbox {
            border-color: #404040;
        }

        .sermon-custom-dropdown-item.selected .sermon-custom-dropdown-checkbox {
            background: #78aaff;
            border-color: #78aaff;
        }

        .sermon-custom-dropdown-checkbox::after {
            content: 'âœ“';
            color: #ffffff;
            font-size: 12px;
            font-weight: bold;
            display: none;
        }

        .sermon-custom-dropdown-item.selected .sermon-custom-dropdown-checkbox::after {
            display: block;
        }

        .sermon-add-verse-btn {
            padding: 12px 20px;
            background: linear-gradient(135deg, #78aaff 0%, #5a94e6 100%);
            border: none;
            border-radius: 12px;
            color: #ffffff;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
            white-space: nowrap;
            height: fit-content;
            box-shadow: 0 2px 8px rgba(120, 170, 255, 0.3);
        }

        .sermon-add-verse-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #8ab8ff 0%, #6ca4f6 100%);
            box-shadow: 0 4px 12px rgba(120, 170, 255, 0.4);
            transform: translateY(-2px);
        }

        .sermon-add-verse-btn:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(120, 170, 255, 0.3);
        }

        .sermon-add-verse-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .sermon-empty-state {
            text-align: center;
            color: #999;
            padding: 2rem;
        }

        body.dark-theme .sermon-empty-state {
            color: #666;
        }

        .sermon-empty-state p {
            margin-top: 1rem;
            font-size: 1rem;
        }

        /* Bottom Sheet Styles */
        .sermon-bottom-sheet-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 200;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sermon-bottom-sheet-overlay.active {
            display: flex;
            opacity: 1;
        }

        .sermon-bottom-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #ffffff;
            border-radius: 16px 16px 0 0;
            z-index: 201;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.15);
            touch-action: none;
            user-select: none;
        }

        body.dark-theme .sermon-bottom-sheet {
            background: #2a2a2a;
        }

        .sermon-bottom-sheet.active {
            transform: translateY(0);
        }

        .sermon-sheet-handle {
            width: 40px;
            height: 4px;
            background: #ccc;
            border-radius: 2px;
            margin: 12px auto 0;
        }

        body.dark-theme .sermon-sheet-handle {
            background: #555;
        }

        #sermon-detail-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 12px 16px;
            border-bottom: 1px solid #e0e0e0;
        }

        body.dark-theme #sermon-detail-header {
            border-bottom-color: #3a3a3a;
        }

        #sermon-detail-header .sermon-date-badge {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            white-space: nowrap;
        }

        .sermon-sheet-header {
            padding: 12px 16px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        body.dark-theme .sermon-sheet-header {
            border-bottom-color: #3a3a3a;
        }

        .sermon-sheet-title {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
            color: #333;
        }

        body.dark-theme .sermon-sheet-title {
            color: #f0f0f0;
        }

        .sermon-sheet-content {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            overflow-x: visible;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .sermon-input-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            position: relative;
        }

        .sermon-input-group.error .sermon-input-text,
        .sermon-input-group.error .sermon-date-picker-btn {
            border-color: #ef4444 !important;
            border-width: 2px;
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.5), inset 0 0 4px rgba(239, 68, 68, 0.1);
        }

        .sermon-input-group.error .sermon-input-label {
            color: #ef4444;
        }

        .sermon-input-error {
            color: #ef4444;
            font-size: 0.85rem;
            margin-top: -0.25rem;
            display: none;
        }

        .sermon-input-group.error .sermon-input-error {
            display: block;
        }

        .sermon-input-label {
            font-weight: 500;
            font-size: 0.95rem;
            color: #333;
        }

        body.dark-theme .sermon-input-label {
            color: #f0f0f0;
        }

        .sermon-input-text {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 1rem;
            font-family: inherit;
            color: #333;
            background: #ffffff;
            transition: all 0.2s;
        }

        body.dark-theme .sermon-input-text {
            background: #252525;
            border-color: #404040;
            color: #f0f0f0;
        }

        .sermon-input-text:focus {
            outline: none;
            border-color: #78aaff;
            background-color: #f5f5f5;
        }

        body.dark-theme .sermon-input-text:focus {
            border-color: #78aaff;
            background-color: #252525;
        }

        /* Date Picker Button */
        .sermon-date-picker-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 12px;
            background-color: #ffffff;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
            color: #333;
            font-family: inherit;
        }

        #sermon-date-display {
            color: #999;
        }

        body.dark-theme #sermon-date-display {
            color: #999;
        }

        body.dark-theme .sermon-date-picker-btn {
            background-color: #252525;
            border-color: #404040;
            color: #f0f0f0;
        }

        .sermon-date-picker-btn:hover {
            background-color: #f5f5f5;
            border-color: #78aaff;
        }

        body.dark-theme .sermon-date-picker-btn:hover {
            background-color: #252525;
            border-color: #78aaff;
        }

        .sermon-date-picker-btn svg {
            width: 20px;
            height: 20px;
        }

        /* Calendar Modal */
        /* Sermon Detail Sheet */
        .sermon-detail-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            z-index: 200;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .sermon-detail-sheet.active ~ .sermon-detail-overlay,
        .sermon-detail-overlay.active {
            display: block;
            opacity: 1;
            pointer-events: auto;
        }

        .sermon-detail-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #ffffff;
            border-radius: 16px 16px 0 0;
            z-index: 201;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.15);
        }

        body.dark-theme .sermon-detail-sheet {
            background: #2a2a2a;
        }

        .sermon-detail-sheet.active {
            transform: translateY(0);
        }

        .sermon-detail-sheet .sermon-sheet-content {
            padding: 16px;
            overflow-y: auto;
        }

        .sermon-detail-close-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #999;
            font-size: 18px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
            flex-shrink: 0;
            position: absolute;
            top: 12px;
            right: 12px;
            opacity: 0;
            pointer-events: none;
        }

        .sermon-detail-sheet.show-close .sermon-detail-close-btn {
            opacity: 1;
            pointer-events: auto;
        }

        .sermon-detail-close-btn:hover {
            background: #f0f0f0;
            color: #333;
            transform: scale(1.1);
        }

        body.dark-theme .sermon-detail-close-btn:hover {
            background: #3a3a3a;
            color: #f0f0f0;
        }

        .sermon-detail-section h3 {
            font-weight: 600;
            font-size: 0.95rem;
            color: #666;
            margin: 0 0 0.5rem 0;
        }

        body.dark-theme .sermon-detail-section h3 {
            color: #999;
        }

        .sermon-verses-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .sermon-verses-header h3 {
            margin: 0;
        }

        .sermon-show-all-link {
            font-size: 0.85rem;
            color: #78aaff;
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .sermon-show-all-link:hover {
            color: #5a92ff;
            text-decoration: underline;
        }

        body.dark-theme .sermon-show-all-link {
            color: #8ab8ff;
        }

        body.dark-theme .sermon-show-all-link:hover {
            color: #a8d0ff;
        }

        .sermon-detail-section p {
            margin: 0;
            color: #333;
            font-size: 0.95rem;
        }

        body.dark-theme .sermon-detail-section p {
            color: #f0f0f0;
        }

        .sermon-detail-verses {
            display: block;
        }

        .sermon-detail-verses .sermon-verse-badge {
            display: table;
            margin-bottom: 0.75rem;
        }

        .sermon-detail-verses .sermon-verse-badge:last-child {
            margin-bottom: 0;
        }

        .sermon-verse-clickable {
            transition: all 0.2s ease;
        }

        .sermon-verse-clickable:hover {
            background-color: #78aaff !important;
            color: #ffffff !important;
            box-shadow: 0 2px 8px rgba(120, 170, 255, 0.3);
            transform: translateY(-2px);
        }

        body.dark-theme .sermon-verse-clickable:hover {
            background-color: #78aaff !important;
            color: #ffffff !important;
        }

        .sermon-detail-actions {
            display: flex;
            gap: 0.75rem;
            padding: 16px;
            border-top: 1px solid #e0e0e0;
            width: 100%;
        }

        body.dark-theme .sermon-detail-actions {
            border-top-color: #3a3a3a;
        }

        .sermon-detail-show-all-section {
            padding: 12px 16px;
            border-top: 1px solid #e0e0e0;
            width: 100%;
        }

        body.dark-theme .sermon-detail-show-all-section {
            border-top-color: #3a3a3a;
        }

        .sermon-detail-show-all-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.2s ease;
            background: #78aaff;
            color: #ffffff;
        }

        .sermon-detail-show-all-btn:hover {
            background: #5a92ff;
            box-shadow: 0 2px 8px rgba(120, 170, 255, 0.3);
        }

        body.dark-theme .sermon-detail-show-all-btn {
            background: #78aaff;
            color: #ffffff;
        }

        body.dark-theme .sermon-detail-show-all-btn:hover {
            background: #5a92ff;
            box-shadow: 0 2px 8px rgba(120, 170, 255, 0.4);
        }

        .sermon-detail-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.2s ease;
            min-width: 0;
            box-sizing: border-box;
        }

        .sermon-detail-close-bottom {
            background: #e8e8e8;
            color: #333;
        }

        .sermon-detail-close-bottom:hover {
            background: #d8d8d8;
        }

        body.dark-theme .sermon-detail-close-bottom {
            background: #3a3a3a;
            color: #f0f0f0;
        }

        body.dark-theme .sermon-detail-close-bottom:hover {
            background: #4a4a4a;
        }

        .sermon-detail-edit {
            background: #78aaff;
            color: white;
        }

        .sermon-detail-edit:hover {
            background: #5a96ff;
        }

        .sermon-detail-delete {
            background: #ff6b6b;
            color: white;
        }

        .sermon-detail-delete:hover {
            background: #ff5252;
        }

        /* Confirmation Dialog */
        .sermon-confirm-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 299;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sermon-confirm-dialog.active ~ .sermon-confirm-backdrop,
        .sermon-confirm-backdrop.active {
            display: block;
            opacity: 1;
        }

        .sermon-confirm-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            z-index: 300;
            background: #ffffff;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            display: none;
            opacity: 0;
            transition: all 0.3s ease;
            min-width: 280px;
        }

        body.dark-theme .sermon-confirm-dialog {
            background: #2a2a2a;
        }

        .sermon-confirm-dialog.active {
            display: block;
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        .sermon-confirm-content {
            padding: 24px;
            text-align: center;
        }

        .sermon-confirm-content p {
            margin: 0 0 24px 0;
            color: #333;
            font-size: 1rem;
        }

        body.dark-theme .sermon-confirm-content p {
            color: #f0f0f0;
        }

        .sermon-confirm-buttons {
            display: flex;
            gap: 12px;
        }

        .sermon-confirm-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.2s ease;
        }

        .sermon-confirm-cancel {
            background: #e0e0e0;
            color: #333;
        }

        .sermon-confirm-cancel:hover {
            background: #d0d0d0;
        }

        body.dark-theme .sermon-confirm-cancel {
            background: #404040;
            color: #f0f0f0;
        }

        body.dark-theme .sermon-confirm-cancel:hover {
            background: #4a4a4a;
        }

        .sermon-confirm-delete {
            background: #ff6b6b;
            color: white;
        }

        .sermon-confirm-delete:hover {
            background: #ff5252;
        }

        .sermon-tamil-title {
            font-size: 0.75rem;
            color: #666;
            margin-top: 0.25rem;
            font-weight: 500;
            line-height: 1.3;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        body.dark-theme .sermon-tamil-title {
            color: #999;
        }

        .sermon-calendar-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 250;
            display: none;
        }

        .sermon-calendar-backdrop.show {
            display: block;
            animation: fadeIn 0.2s ease-in-out;
        }

        .sermon-calendar-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 260;
            display: none;
        }

        .sermon-calendar-modal.show {
            display: block;
            animation: slideUp 0.3s ease-out;
        }

        .sermon-calendar-content {
            width: 328px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            background-color: #ffffff;
        }

        body.dark-theme .sermon-calendar-content {
            background-color: #2a2a2a;
        }

        .sermon-calendar-header {
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #e0e0e0;
        }

        body.dark-theme .sermon-calendar-header {
            border-bottom-color: #3a3a3a;
        }

        .sermon-calendar-title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        body.dark-theme .sermon-calendar-title {
            color: #f0f0f0;
        }

        .sermon-calendar-nav-btn {
            width: 36px;
            height: 36px;
            padding: 6px;
            border: none;
            background: transparent;
            border-radius: 50%;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
            color: #333;
        }

        body.dark-theme .sermon-calendar-nav-btn {
            color: #f0f0f0;
        }

        .sermon-calendar-nav-btn:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }

        body.dark-theme .sermon-calendar-nav-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .sermon-calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            padding: 8px 12px;
        }

        .sermon-calendar-weekday {
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            color: #999;
            letter-spacing: 0.5px;
        }

        body.dark-theme .sermon-calendar-weekday {
            color: #999;
        }

        .sermon-calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 50%;
            font-size: 13px;
            font-weight: 400;
            margin: 2px;
            transition: all 0.2s;
            color: #333;
        }

        body.dark-theme .sermon-calendar-day {
            color: #f0f0f0;
        }

        .sermon-calendar-day:hover:not(.other-month):not(.selected) {
            background-color: rgba(120, 170, 255, 0.1);
        }

        .sermon-calendar-day.selected {
            background-color: #78aaff;
            color: #ffffff;
            font-weight: 500;
        }

        .sermon-calendar-day.today:not(.selected) {
            border: 2px solid #78aaff;
            color: #78aaff;
            font-weight: 500;
        }

        .sermon-calendar-day.other-month {
            color: #ccc;
            cursor: default;
        }

        body.dark-theme .sermon-calendar-day.other-month {
            color: #555;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translate(-50%, -40%);
                opacity: 0;
            }

            to {
                transform: translate(-50%, -50%);
                opacity: 1;
            }
        }

        .sermon-sheet-buttons {
            display: flex;
            gap: 1rem;
            padding: 16px;
            border-top: 1px solid #e0e0e0;
        }

        body.dark-theme .sermon-sheet-buttons {
            border-top-color: #3a3a3a;
        }

        .sermon-btn {
            flex: 1;
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .sermon-btn-cancel {
            background: #f0f0f0;
            color: #333;
        }

        body.dark-theme .sermon-btn-cancel {
            background: #3a3a3a;
            color: #f0f0f0;
        }

        .sermon-btn-cancel:hover {
            background: #e0e0e0;
        }

        body.dark-theme .sermon-btn-cancel:hover {
            background: #444;
        }

        .sermon-btn-save {
            background: #78aaff;
            color: #ffffff;
        }

        .sermon-btn-save:hover {
            background: #5a94e6;
        }

        .sermon-btn-save:active {
            background: #4a84d6;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .sermon-top-nav {
                padding: 10px 12px;
            }

            .sermon-nav-title {
                font-size: 18px;
            }

            .sermon-content {
                padding: 1rem;
            }

            .sermon-list {
                gap: 0.75rem;
            }

            .sermon-item {
                padding: 0.75rem;
            }

            .sermon-bottom-sheet {
                max-height: 90vh;
            }
        }

        /* Passage popup modal styles */
        .passage-popup {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0);
            display: flex;
            align-items: flex-end;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease, background-color 0.3s ease;
        }

        .passage-popup.show {
            opacity: 1;
            pointer-events: auto;
            background: rgba(0, 0, 0, 0.6);
        }

        .passage-modal-card {
            background: #ffffff;
            border-radius: 16px 16px 0 0;
            max-height: 85vh;
            width: 100%;
            display: flex;
            flex-direction: column;
            animation: slideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
            transform: translateY(0);
        }

        .passage-popup:not(.show) .passage-modal-card {
            animation: slideDown 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideDown {
            from {
                transform: translateY(0);
                opacity: 1;
            }
            to {
                transform: translateY(100%);
                opacity: 0;
            }
        }

        .passage-header-handle {
            width: 40px;
            height: 4px;
            background: #d0d0d0;
            border-radius: 2px;
            opacity: 0.6;
        }

        body.dark-theme .passage-header-handle {
            background: #444444;
        }

        .passage-header-container {
            display: flex;
            justify-content: center;
            padding: 12px 0 0 0;
            border-radius: 16px 16px 0 0;
            background: #ffffff;
        }

        body.dark-theme .passage-header-container {
            background: #2a2a2a;
        }

        body.dark-theme .passage-modal-card {
            background: #2a2a2a;
            color: #f0f0f0;
        }

        .passage-header {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding: 16px;
            border-bottom: 1px solid #e0e0e0;
            cursor: grab;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }

        .passage-header:active {
            cursor: grabbing;
        }

        body.dark-theme .passage-header {
            border-bottom-color: #3a3a3a;
        }

        .passage-badge {
            font-size: 16px;
            font-weight: 600;
            margin: 0;
            color: #333;
        }

        body.dark-theme .passage-badge {
            color: #f0f0f0;
        }



        .passage-language-buttons {
            display: flex;
            gap: 8px;
            padding: 12px 16px;
            border-bottom: 1px solid #e0e0e0;
        }

        body.dark-theme .passage-language-buttons {
            border-bottom-color: #3a3a3a;
        }

        .passage-lang-btn {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: #f5f5f5;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: #666;
            transition: all 0.2s;
        }

        .passage-lang-btn.active {
            background: #78aaff;
            color: #ffffff;
            border-color: #78aaff;
        }

        body.dark-theme .passage-lang-btn {
            background: #1a1a1a;
            border-color: #3a3a3a;
            color: #999;
        }

        body.dark-theme .passage-lang-btn.active {
            background: #78aaff;
            border-color: #78aaff;
            color: #ffffff; 
        }

        .passage-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            font-size: 15px;
            line-height: 2;
        }

        .passage-content p {
            margin: 0 0 20px 0;
        }

        .passage-content p:last-child {
            margin-bottom: 20px;
        }

        .verse-title-divider {
            padding: 0 0 0 0;
            margin: 24px 0 16px 0;
            text-align: left;
        }

        .verse-title {
            margin: 0 0 12px 0;
            font-size: 0.95rem;
            font-weight: 600;
            color: #78aaff;
            display: inline-block;
            padding: 6px 12px;
            background: rgba(120, 170, 255, 0.15);
            border: 1px solid rgba(120, 170, 255, 0.25);
            border-radius: 20px;
        }

        body.dark-theme .verse-title {
            color: #8ab8ff;
            background: rgba(120, 170, 255, 0.1);
            border-color: rgba(120, 170, 255, 0.2);
        }

        .verse-separator {
            border: none;
            border-top: 1px solid #e0e0e0;
            margin: 24px 0;
        }

        body.dark-theme .verse-separator {
            border-top-color: #3a3a3a;
        }

        .passage-no-data {
            color: #999;
            text-align: center;
            padding: 32px 16px;
        }

        body.dark-theme .passage-no-data {
            color: #666;
        }

        .passage-loader {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100px;
        }

        .passage-loader-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #333333;
            border-top: 5px solid #ffffff;
            border-right: 5px solid #cccccc;
            border-radius: 50%;
            animation: sermon-spin 1s linear infinite;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
        }

        body.dark-theme .passage-loader-spinner {
            border-color: #333333;
            border-top-color: #ffffff;
            border-right-color: #cccccc;
        }
    </style>
</head>

<body class="dark-theme">
    <div class="sermon-container">
        <!-- Header matching Life of Jesus style -->
        <div class="sermon-top-nav">
            <button class="sermon-back-btn" id="sermon-back-btn" aria-label="Back">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M19 12H5M5 12L12 19M5 12L12 5" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round" />
                </svg>
            </button>
            <h1 class="sermon-nav-title">Sermons</h1>
            <button class="sermon-add-btn" id="sermon-add-btn" aria-label="Add Sermon">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" />
                </svg>
            </button>
        </div>

        <!-- Content area with sermon list -->
        <div class="sermon-content">
            <!-- Loader -->
            <div class="sermon-loader-wrapper" id="sermon-loader">
                <div class="sermon-loader-spinner"></div>
                <p class="sermon-loader-text">Loading...</p>
            </div>
            
            <div class="sermon-list" id="sermon-list">
                <div class="sermon-empty-state">
                    <p>No sermons yet</p>
                    <p style="font-size: 0.9rem; margin-top: 0.5rem;">Tap the + button to add a sermon</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Sheet for Adding Sermon -->
    <div class="sermon-bottom-sheet-overlay" id="sermon-sheet-overlay"></div>
    <div class="sermon-bottom-sheet" id="sermon-bottom-sheet">
        <div class="sermon-sheet-handle" id="sermon-sheet-drag-handle"></div>
        <div class="sermon-sheet-header">
            <h2 class="sermon-sheet-title">Add Sermon</h2>
        </div>
        <div class="sermon-sheet-content">
            <div class="sermon-input-group">
                <label class="sermon-input-label">Sermon Title</label>
                <input type="text" class="sermon-input-text" id="sermon-title-input" placeholder="Enter sermon title..."
                    autocomplete="off">
                <div class="sermon-input-error">Sermon title is required</div>
            </div>
            <div class="sermon-input-group">
                <label class="sermon-input-label">Tamil Title (Optional)</label>
                <input type="text" class="sermon-input-text" id="sermon-tamil-title-input" placeholder="Enter Tamil title..."
                    autocomplete="off">
            </div>
            <div class="sermon-input-group">
                <label class="sermon-input-label">Sermon Date</label>
                <button class="sermon-date-picker-btn" id="sermon-date-picker-btn">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M19 4H5C3.89543 4 3 4.89543 3 6V20C3 21.1046 3.89543 22 5 22H19C20.1046 22 21 21.1046 21 20V6C21 4.89543 20.1046 4 19 4Z"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        <path d="M16 2V6M8 2V6M3 10H21" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round" />
                    </svg>
                    <span id="sermon-date-display">Select date</span>
                </button>
                <input type="hidden" id="sermon-date-input">
                <div class="sermon-input-error">Sermon date is required</div>
            </div>
            <div class="sermon-input-group">
                <div class="sermon-dropdowns-container">
                    <div class="sermon-dropdowns-row">
                        <div class="sermon-dropdown-group">
                            <label class="sermon-dropdown-label">Book</label>
                            <select class="sermon-dropdown-select" id="sermon-book-select">
                                <option value="">Select Book</option>
                            </select>
                        </div>
                        <div class="sermon-dropdown-group">
                            <label class="sermon-dropdown-label">Chapter</label>
                            <select class="sermon-dropdown-select" id="sermon-chapter-select" disabled>
                                <option value="">Select Chapter</option>
                            </select>
                        </div>
                    </div>
                    <div class="sermon-verses-row">
                        <div class="sermon-dropdown-group">
                            <label class="sermon-dropdown-label">Verses</label>
                            <select class="sermon-dropdown-select" id="sermon-verses-select" multiple disabled>
                            </select>
                        </div>
                        <button class="sermon-add-verse-btn" id="sermon-add-verse-btn" type="button" disabled>Add Verse</button>
                    </div>
                </div>
                <div class="sermon-verses-chips" id="sermon-verses-chips"></div>
            </div>
        </div>
        <div class="sermon-sheet-buttons">
            <button class="sermon-btn sermon-btn-cancel" id="sermon-btn-cancel">Cancel</button>
            <button class="sermon-btn sermon-btn-save" id="sermon-btn-save">Save</button>
        </div>
    </div>

    <!-- Calendar Modal for Date Picker -->
    <!-- Sermon Detail Bottom Sheet -->
    <div class="sermon-detail-overlay" id="sermon-detail-overlay" onclick="closeSermonDetail()"></div>
    <div class="sermon-detail-sheet" id="sermon-detail-sheet">
        <div class="sermon-sheet-handle"></div>
        <div class="sermon-sheet-header" id="sermon-detail-header">
            <h2 class="sermon-sheet-title">Sermon Details</h2>
            <button class="sermon-detail-close-btn" id="sermon-detail-close-btn" aria-label="Close">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="width: 100%; height: 100%;">
                    <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
            </button>
        </div>
        <div class="sermon-sheet-content" id="sermon-detail-content"></div>
    </div>

    <!-- Confirmation Dialog -->
    <div class="sermon-confirm-backdrop" id="sermon-confirm-backdrop" onclick="cancelConfirmDialog()"></div>
    <div class="sermon-confirm-dialog" id="sermon-confirm-dialog">
        <div class="sermon-confirm-content">
            <p id="sermon-confirm-message"></p>
            <div class="sermon-confirm-buttons">
                <button class="sermon-confirm-btn sermon-confirm-cancel" onclick="cancelConfirmDialog()">Cancel</button>
                <button class="sermon-confirm-btn sermon-confirm-delete" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <div class="sermon-calendar-backdrop" id="sermon-calendar-backdrop" onclick="closeSermonCalendar()"></div>
    <div class="sermon-calendar-modal" id="sermon-calendar-modal">
        <div class="sermon-calendar-content">
            <div class="sermon-calendar-header">
                <button class="sermon-calendar-nav-btn" onclick="prevSermonMonth()" aria-label="Previous month">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M15 19L8 12L15 5" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round" />
                    </svg>
                </button>
                <div class="sermon-calendar-title" id="sermon-calendar-title"></div>
                <button class="sermon-calendar-nav-btn" onclick="nextSermonMonth()" aria-label="Next month">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M9 5L16 12L9 19" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round" />
                    </svg>
                </button>
            </div>
            <div class="sermon-calendar-grid" id="sermon-calendar-grid"></div>
        </div>
    </div>

    <script>
        // Bible metadata - simplified structure
        const bibleMeta = [
            { book: "Genesis", chapters: [31, 25, 24, 26, 32, 22, 24, 22, 29, 32, 32, 20, 18, 24, 21, 16, 27, 33, 38, 18, 34, 24, 20, 67, 34, 35, 46, 22, 35, 43, 55, 32, 20, 29, 23, 29, 43, 36, 30, 23, 23, 18, 22, 28, 34, 34, 28, 34, 31, 22] },
            { book: "Exodus", chapters: [22, 25, 22, 31, 23, 30, 25, 32, 35, 29, 10, 51, 22, 31, 27, 36, 16, 27, 25, 26, 36, 31, 33, 18, 40, 37, 21, 43, 46, 38, 18, 35, 23, 35, 35, 38, 29, 31, 43, 38] },
            { book: "Leviticus", chapters: [17, 16, 17, 35, 19, 30, 38, 36, 24, 20, 47, 8, 59, 57, 33, 34, 16, 30, 37, 27, 24, 33, 44, 23, 55, 46, 34] },
            { book: "Numbers", chapters: [54, 34, 51, 49, 31, 27, 89, 26, 23, 36, 35, 16, 31, 41, 41, 35, 28, 32, 22, 29, 35, 41, 30, 25, 18, 65, 23, 31, 39, 17, 54, 42, 56, 29, 34, 13] },
            { book: "Deuteronomy", chapters: [46, 37, 29, 49, 33, 25, 26, 20, 29, 22, 32, 32, 18, 29, 23, 22, 20, 22, 21, 20, 23, 30, 25, 22, 19, 19, 26, 69, 28, 20, 30, 52, 29, 12] },
            { book: "Joshua", chapters: [18, 24, 17, 24, 15, 27, 26, 35, 27, 43, 23, 24, 33, 15, 63, 10, 18, 28, 51, 9, 45, 34, 16, 33] },
            { book: "Judges", chapters: [36, 23, 31, 24, 31, 40, 25, 35, 57, 18, 40, 15, 25, 20, 20, 31, 13, 31, 30, 48, 25] },
            { book: "Ruth", chapters: [22, 23, 18, 22] },
            { book: "1 Samuel", chapters: [28, 36, 21, 22, 12, 21, 17, 22, 27, 27, 15, 25, 23, 52, 35, 23, 58, 30, 24, 42, 15, 23, 29, 22, 44, 25, 12, 25, 11, 31, 13] },
            { book: "2 Samuel", chapters: [27, 32, 39, 12, 25, 23, 29, 18, 13, 19, 27, 31, 39, 33, 37, 23, 29, 33, 43, 26, 22, 51, 39, 25] },
            { book: "1 Kings", chapters: [53, 46, 28, 34, 18, 38, 51, 66, 28, 29, 43, 33, 34, 31, 34, 34, 24, 46, 21, 43, 29, 53] },
            { book: "2 Kings", chapters: [18, 25, 27, 44, 27, 33, 20, 29, 37, 36, 21, 21, 25, 29, 38, 20, 41, 37, 37, 21, 26, 20, 37, 20, 30] },
            { book: "1 Chronicles", chapters: [54, 55, 24, 43, 41, 66, 40, 40, 44, 14, 47, 40, 14, 17, 29, 43, 27, 17, 19, 8, 30, 19, 32, 31, 31, 32, 34, 21, 30] },
            { book: "2 Chronicles", chapters: [17, 18, 17, 22, 14, 42, 22, 18, 31, 19, 23, 16, 22, 15, 19, 14, 19, 34, 11, 37, 20, 12, 21, 27, 28, 23, 9, 27, 36, 27, 21, 33, 25, 33, 27, 23] },
            { book: "Ezra", chapters: [11, 70, 13, 24, 17, 22, 28, 36, 15, 44] },
            { book: "Nehemiah", chapters: [11, 20, 32, 23, 19, 19, 73, 18, 38, 39, 36, 47, 31] },
            { book: "Esther", chapters: [22, 23, 15, 17, 14, 14, 10, 17, 32, 3] },
            { book: "Job", chapters: [22, 13, 26, 21, 27, 30, 21, 22, 35, 22, 20, 25, 28, 22, 35, 22, 16, 21, 29, 29, 34, 30, 17, 25, 6, 14, 23, 28, 25, 31, 40, 22, 33, 37, 16, 33, 24, 41, 30, 24, 34, 17] },
            { book: "Psalms", chapters: [6, 12, 8, 8, 12, 10, 17, 9, 20, 18, 7, 8, 6, 7, 5, 11, 15, 51, 15, 10, 14, 32, 6, 10, 22, 12, 14, 9, 11, 12, 24, 11, 22, 23, 28, 12, 40, 22, 13, 17, 13, 11, 5, 26, 17, 11, 9, 14, 20, 23, 19, 9, 6, 7, 23, 13, 11, 11, 17, 12, 8, 12, 11, 10, 13, 20, 7, 35, 36, 5, 24, 20, 28, 23, 10, 12, 20, 72, 13, 19, 16, 8, 18, 12, 13, 17, 7, 18, 52, 17, 16, 15, 5, 23, 11, 13, 12, 9, 9, 5, 8, 28, 22, 35, 45, 48, 43, 13, 31, 7, 10, 10, 9, 11, 14, 9, 6, 7, 9, 45, 48, 43, 13, 31, 7, 10, 10, 9, 11, 14, 9, 6, 7, 9] },
            { book: "Proverbs", chapters: [33, 22, 35, 27, 23, 35, 27, 36, 18, 32, 31, 28, 25, 35, 33, 33, 28, 24, 29, 30, 31, 29, 35, 34, 28, 28, 27, 28, 27, 33, 31] },
            { book: "Ecclesiastes", chapters: [18, 26, 22, 16, 20, 12, 29, 17, 18, 20, 10, 14] },
            { book: "Song of Solomon", chapters: [17, 17, 11, 16, 16, 13, 13, 14] },
            { book: "Isaiah", chapters: [31, 22, 26, 6, 30, 13, 25, 22, 21, 34, 16, 6, 22, 32, 9, 14, 14, 7, 25, 6, 17, 25, 18, 23, 12, 21, 13, 29, 24, 33, 9, 20, 24, 17, 10, 22, 38, 22, 8, 31, 29, 25, 28, 28, 25, 13, 15, 22, 26, 11, 23, 15, 12, 17, 13, 12, 21, 14, 21, 22, 11, 12, 19, 12] },
            { book: "Jeremiah", chapters: [19, 37, 25, 31, 31, 30, 34, 22, 26, 25, 23, 17, 27, 22, 21, 21, 27, 23, 15, 18, 14, 30, 40, 10, 38, 24, 22, 17, 32, 24, 40, 44, 26, 22, 19, 32, 21, 28, 18, 16, 18, 22, 13, 30, 5, 28, 7, 47, 39, 46, 64, 34] },
            { book: "Lamentations", chapters: [22, 22, 66, 22, 22] },
            { book: "Ezekiel", chapters: [28, 10, 27, 17, 17, 14, 27, 18, 11, 22, 25, 28, 23, 23, 8, 63, 24, 32, 14, 49, 32, 31, 49, 27, 17, 21, 36, 26, 21, 26, 18, 32, 33, 31, 15, 38, 28, 24, 49, 26, 20, 27, 31, 25, 24, 23, 35] },
            { book: "Daniel", chapters: [21, 49, 30, 37, 31, 28, 28, 27, 27, 21, 45, 13] },
            { book: "Hosea", chapters: [11, 23, 5, 19, 15, 11, 16, 14, 17, 15, 12, 14, 16, 9] },
            { book: "Joel", chapters: [20, 32, 21] },
            { book: "Amos", chapters: [15, 16, 15, 13, 27, 14, 17, 14, 15] },
            { book: "Obadiah", chapters: [21] },
            { book: "Jonah", chapters: [17, 10, 10, 11] },
            { book: "Micah", chapters: [16, 13, 12, 13, 15, 16, 20] },
            { book: "Nahum", chapters: [15, 13, 19] },
            { book: "Habakkuk", chapters: [17, 20, 19] },
            { book: "Zephaniah", chapters: [18, 15, 20] },
            { book: "Haggai", chapters: [15, 23] },
            { book: "Zechariah", chapters: [21, 13, 10, 14, 11, 15, 14, 23, 17, 12, 17, 14, 9, 21] },
            { book: "Malachi", chapters: [14, 17, 18, 6] },
            { book: "Matthew", chapters: [25, 23, 17, 25, 48, 34, 29, 34, 38, 42, 30, 50, 58, 36, 39, 28, 27, 35, 30, 34, 46, 46, 39, 51, 46, 75, 66, 20] },
            { book: "Mark", chapters: [45, 28, 35, 41, 43, 56, 37, 38, 50, 52, 33, 44, 37, 72, 47, 20] },
            { book: "Luke", chapters: [80, 52, 38, 44, 39, 49, 50, 56, 62, 42, 54, 59, 35, 35, 32, 31, 37, 43, 48, 47, 38, 71, 56, 53] },
            { book: "John", chapters: [51, 25, 36, 54, 47, 71, 53, 59, 41, 42, 57, 50, 38, 31, 27, 33, 26, 40, 42, 31, 25] },
            { book: "Acts", chapters: [26, 47, 26, 37, 42, 15, 60, 40, 43, 48, 30, 25, 52, 28, 41, 40, 34, 28, 41, 38, 40, 30, 35, 27, 27, 32, 44, 31] },
            { book: "Romans", chapters: [32, 29, 31, 25, 21, 23, 25, 39, 33, 21, 36, 21, 14, 23, 33, 27] },
            { book: "1 Corinthians", chapters: [31, 16, 23, 21, 13, 20, 40, 13, 27, 33, 34, 31, 13, 40, 58, 24] },
            { book: "2 Corinthians", chapters: [24, 17, 18, 18, 21, 18, 16, 24, 15, 18, 33, 21, 14] },
            { book: "Galatians", chapters: [24, 21, 29, 31, 26, 18] },
            { book: "Ephesians", chapters: [23, 22, 21, 32, 33, 24] },
            { book: "Philippians", chapters: [30, 30, 21, 23] },
            { book: "Colossians", chapters: [29, 23, 25, 18] },
            { book: "1 Thessalonians", chapters: [10, 20, 13, 18, 28] },
            { book: "2 Thessalonians", chapters: [12, 17, 18] },
            { book: "1 Timothy", chapters: [20, 15, 16, 16, 25, 21] },
            { book: "2 Timothy", chapters: [18, 26, 17, 22] },
            { book: "Titus", chapters: [16, 15, 15] },
            { book: "Philemon", chapters: [25] },
            { book: "Hebrews", chapters: [14, 18, 19, 16, 14, 20, 28, 13, 28, 39, 40, 29, 25] },
            { book: "James", chapters: [27, 26, 18, 17, 20] },
            { book: "1 Peter", chapters: [25, 25, 22, 19, 14] },
            { book: "2 Peter", chapters: [21, 22, 18] },
            { book: "1 John", chapters: [10, 29, 24, 21, 21] },
            { book: "2 John", chapters: [13] },
            { book: "3 John", chapters: [14] },
            { book: "Jude", chapters: [25] },
            { book: "Revelation", chapters: [20, 29, 22, 11, 14, 17, 17, 13, 21, 11, 19, 17, 18, 20, 8, 21, 18, 24, 21, 15, 27, 21] }
        ];

        // Sermon management
        let sermons = [];
        let currentCalendarDate = new Date();
        let selectedSermonDate = null;
        let selectedSermonVerses = [];
        let nextSermonId = 10001;  // Starting ID for sermons
        
        // Check if admin is enabled
        function isAdmin() {
            const adminStatus = localStorage.getItem('isAdmin');
            if (adminStatus === null) {
                localStorage.setItem('isAdmin', 'false');
                return false;
            }
            return adminStatus === 'true';
        }
        
        // Disable zoom and copy functionality
        document.addEventListener('touchmove', function(e) {
            if (e.touches.length > 1) {
                e.preventDefault();  // Disable pinch zoom
            }
        }, { passive: false });

        // Disable double-tap zoom
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(e) {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) {
                e.preventDefault();  // Disable double-tap zoom
            }
            lastTouchEnd = now;
        }, false);

        // Disable copy
        document.addEventListener('copy', (e) => {
            e.preventDefault();
            return false;
        });

        // Disable context menu
        document.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            return false;
        });
        
        // Generate next sermon ID
        function generateSermonId() {
            const maxId = sermons.reduce((max, sermon) => {
                const id = parseInt(sermon.id) || 10000;
                return id > max ? id : max;
            }, 10000);
            nextSermonId = maxId + 1;
            return nextSermonId;
        }
        
        // Supabase configuration
        const SUPABASE_URL = 'https://encjogfdbrfcatvytpir.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVuY2pvZ2ZkYnJmY2F0dnl0cGlyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1NDM2MzksImV4cCI6MjA3OTExOTYzOX0.X3jHo2YTwQa0j8HTjhi7fkO1wU2rb6jwngRjVKaF6ck';
        let supabase = null;
        let syncEnabled = false;
        
        // Initialize Supabase
        async function initSupabase() {
            try {
                // Check if Supabase is available in the global scope
                if (window.supabase && window.supabase.createClient) {
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    syncEnabled = true;
                    console.log('Supabase initialized successfully');
                } else {
                    console.warn('Supabase library not loaded yet');
                    syncEnabled = false;
                }
            } catch (error) {
                console.warn('Supabase initialization failed:', error);
                syncEnabled = false;
            }
        }

        // Initialize book dropdown
        function initializeBookDropdown() {
            const bookSelect = document.getElementById('sermon-book-select');
            bibleMeta.forEach(book => {
                const option = document.createElement('option');
                option.value = book.book;
                option.textContent = book.book;
                bookSelect.appendChild(option);
            });
            
            // Add dummy verses (1-5) to verses select initially
            const versesSelect = document.getElementById('sermon-verses-select');
            for (let i = 1; i <= 5; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                versesSelect.appendChild(option);
            }
        }

        // Handle book selection
        document.getElementById('sermon-book-select').addEventListener('change', function () {
            const selectedBook = this.value;
            const chapterSelect = document.getElementById('sermon-chapter-select');
            const versesSelect = document.getElementById('sermon-verses-select');

            chapterSelect.innerHTML = '<option value="">Select Chapter</option>';
            
            // Reset to dummy verses
            versesSelect.innerHTML = '';
            for (let i = 1; i <= 5; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                versesSelect.appendChild(option);
            }
            versesSelect.disabled = true;

            if (selectedBook) {
                const book = bibleMeta.find(b => b.book === selectedBook);
                book.chapters.forEach((_, index) => {
                    const option = document.createElement('option');
                    option.value = index + 1;
                    option.textContent = index + 1;
                    chapterSelect.appendChild(option);
                });
                chapterSelect.disabled = false;
            } else {
                chapterSelect.disabled = true;
            }
        });

        // Handle chapter selection
        document.getElementById('sermon-chapter-select').addEventListener('change', function () {
            const bookSelect = document.getElementById('sermon-book-select');
            const selectedBook = bookSelect.value;
            const selectedChapter = parseInt(this.value);
            const versesSelect = document.getElementById('sermon-verses-select');

            // Clear all options first
            versesSelect.innerHTML = '';

            if (selectedChapter) {
                const book = bibleMeta.find(b => b.book === selectedBook);
                const verseCount = book.chapters[selectedChapter - 1];
                
                // Remove dummy verses and add actual verses for the chapter
                for (let i = 1; i <= verseCount; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    versesSelect.appendChild(option);
                }
                versesSelect.disabled = false;
            } else {
                // Reset to dummy verses if no chapter selected
                for (let i = 1; i <= 5; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    versesSelect.appendChild(option);
                }
                versesSelect.disabled = true;
            }
        });

        // Handle verse selection
        document.getElementById('sermon-verses-select').addEventListener('change', function () {
            const addBtn = document.getElementById('sermon-add-verse-btn');
            addBtn.disabled = this.selectedOptions.length === 0;
        });

        // Add verse reference
        document.getElementById('sermon-add-verse-btn').addEventListener('click', function () {
            const bookSelect = document.getElementById('sermon-book-select');
            const chapterSelect = document.getElementById('sermon-chapter-select');
            const versesSelect = document.getElementById('sermon-verses-select');

            const book = bookSelect.value;
            const chapter = chapterSelect.value;
            const verses = Array.from(versesSelect.selectedOptions).map(opt => opt.value);

            if (book && chapter && verses.length > 0) {
                const verseStart = verses[0];
                const verseEnd = verses[verses.length - 1];
                const verseRange = verseStart === verseEnd ? verseStart : `${verseStart} â€“ ${verseEnd}`;

                const verseRef = {
                    book,
                    chapter,
                    verseStart: parseInt(verseStart),
                    verseEnd: parseInt(verseEnd),
                    display: `${book} ${chapter} : ${verseRange}`
                };

                selectedSermonVerses.push(verseRef);
                renderVersesChips();

                // Reset selects
                versesSelect.value = '';
                versesSelect.disabled = true;
                chapterSelect.value = '';
                chapterSelect.disabled = true;
                bookSelect.value = '';
                this.disabled = true;
            }
        });

        // Render verse chips
        function renderVersesChips() {
            const chipsContainer = document.getElementById('sermon-verses-chips');
            chipsContainer.innerHTML = selectedSermonVerses.map((verse, index) => `
                <div class="sermon-verse-chip">
                    ${verse.display}
                    <button type="button" class="sermon-verse-chip-remove" onclick="removeVerseReference(${index})">Ã—</button>
                </div>
            `).join('');
        }

        // Remove verse reference
        window.removeVerseReference = function (index) {
            selectedSermonVerses.splice(index, 1);
            renderVersesChips();
        };

        // Load sermons from Supabase
        async function loadSermonsFromSupabase() {
            const loader = document.getElementById('sermon-loader');
            if (loader) loader.classList.remove('hidden');

            if (!supabase) {
                console.log('Supabase not available, loading from localStorage');
                loadSermonsFromLocalStorage();
                if (loader) loader.classList.add('hidden');
                return;
            }

            try {
                console.log('Loading sermons from Supabase...');
                const { data, error } = await supabase
                    .from('sermons')
                    .select('*')
                    .order('sermon_date', { ascending: false });

                if (error) {
                    console.error('Error loading sermons from Supabase:', error);
                    loadSermonsFromLocalStorage();
                    if (loader) loader.classList.add('hidden');
                    return;
                }

                if (data && data.length > 0) {
                    // Convert Supabase data to local format
                    sermons = data.map(item => ({
                        id: item.id,
                        title: item.title,
                        tamilTitle: item.tamil_title || '',
                        date: item.sermon_date,
                        verses: item.verses || [],
                        _synced: true  // Mark as synced from Supabase
                    }));
                    
                    console.log('Loaded', sermons.length, 'sermons from Supabase');
                    
                    // Save to localStorage as backup
                    localStorage.setItem('sermons', JSON.stringify(sermons));
                } else {
                    console.log('No sermons found in Supabase, loading from localStorage');
                    loadSermonsFromLocalStorage();
                    if (loader) loader.classList.add('hidden');
                    return;
                }

                renderSermons();
                if (loader) loader.classList.add('hidden');
            } catch (error) {
                console.error('Error loading sermons from Supabase:', error);
                loadSermonsFromLocalStorage();
                if (loader) loader.classList.add('hidden');
            }
        }

        // Load sermons from localStorage (fallback)
        function loadSermonsFromLocalStorage() {
            const saved = localStorage.getItem('sermons');
            if (saved) {
                try {
                    sermons = JSON.parse(saved);
                    console.log('Loaded', sermons.length, 'sermons from localStorage');
                } catch (e) {
                    console.error('Error loading sermons from localStorage:', e);
                }
            }
        }

        // Load sermons (uses Supabase if available, falls back to localStorage)
        async function loadSermons() {
            await loadSermonsFromSupabase();
            // Preload all verses from all sermons in background (non-blocking)
            preloadAllSermonsVerses();
        }

        // Render sermons list
        function renderSermons() {
            const sermonList = document.getElementById('sermon-list');

            if (sermons.length === 0) {
                sermonList.innerHTML = `
                    <div class="sermon-empty-state">
                        <p>No sermons yet</p>
                        <p style="font-size: 0.9rem; margin-top: 0.5rem;">Tap the + button to add a sermon</p>
                    </div>
                `;
                return;
            }

            // Sort sermons by date (newest first)
            const sortedSermons = [...sermons].sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                return dateB - dateA;  // Descending order (newest first)
            });

            sermonList.innerHTML = sortedSermons.map((sermon, sortedIndex) => {
                // Find the original index in the sermons array for onclick handlers
                const originalIndex = sermons.findIndex(s => s.id === sermon.id);
                
                const date = new Date(sermon.date);
                const dateStr = formatSermonDate(date);
                let versesHtml = '';
                if (sermon.verses && sermon.verses.length > 0) {
                    versesHtml = sermon.verses.slice(0, 2).map((v, idx) => {
                        const moreCount = sermon.verses.length > 2 && idx === 1 ? sermon.verses.length - 2 : 0;
                        return `
                            <div class="sermon-verse-item">
                                <span class="sermon-verse-badge">${v.display}</span>
                                ${moreCount > 0 ? `<span class="sermon-verse-more">+${moreCount} more</span>` : ''}
                            </div>
                        `;
                    }).join('');
                }
                return `
                    <div class="sermon-item" data-index="${originalIndex}">
                        <div class="sermon-item-header">
                            <div class="sermon-item-title-wrapper">
                                <h3 class="sermon-item-title">${sermon.title}</h3>
                                ${sermon.tamilTitle ? `<p class="sermon-tamil-title">${sermon.tamilTitle}</p>` : ''}
                            </div>
                            <span class="sermon-date-badge">
                                <svg class="sermon-date-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                    <rect x="3" y="4" width="18" height="18" rx="2" fill="none" stroke="currentColor" stroke-width="2"/>
                                    <path d="M 3 9 L 21 9" stroke="currentColor" stroke-width="2"/>
                                    <line x1="9" y1="1" x2="9" y2="7" stroke="currentColor" stroke-width="2"/>
                                    <line x1="15" y1="1" x2="15" y2="7" stroke="currentColor" stroke-width="2"/>
                                </svg>
                                ${dateStr}
                            </span>
                        </div>
                        ${versesHtml ? `<div class="sermon-item-verses">${versesHtml}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        // Format date as Wed, dd/mm/yy
        function formatSermonDate(date) {
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const dayName = days[date.getDay()];
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = String(date.getFullYear()).slice(-2);
            return `${dayName}, ${day}/${month}/${year}`;
        }

        // Save sermons to localStorage
        function saveSermons() {
            localStorage.setItem('sermons', JSON.stringify(sermons));
            
            // Sync to Supabase if enabled
            if (syncEnabled && supabase) {
                syncSermonsToSupabase();
            }
        }
        
        // Sync sermons to Supabase
        async function syncSermonsToSupabase() {
            if (!supabase) {
                console.log('Sync skipped - supabase not available');
                return;
            }
            
            console.log('Starting sermon sync, total sermons:', sermons.length);
            
            try {
                for (const sermon of sermons) {
                    // Skip if already synced to Supabase
                    if (sermon._synced) {
                        continue;
                    }
                    
                    const dateStr = sermon.date instanceof Date 
                        ? sermon.date.toISOString().split('T')[0]
                        : sermon.date.split('T')[0];
                    
                    // Sync new sermons (with sequential IDs like 10001, 10002, etc)
                    if (sermon.id && sermon.id >= 10001) {
                        console.log('Syncing new sermon:', sermon.title, 'ID:', sermon.id);
                        const { data, error } = await supabase
                            .from('sermons')
                            .insert([{
                                id: sermon.id,
                                title: sermon.title,
                                tamil_title: sermon.tamilTitle || null,
                                sermon_date: dateStr,
                                verses: sermon.verses || []
                            }])
                            .select();
                        
                        if (error) {
                            console.error('Error syncing sermon to Supabase:', error);
                        } else if (data && data.length > 0) {
                            console.log('Successfully synced sermon to Supabase with ID:', data[0].id);
                            sermon._synced = true;  // Mark as synced
                        }
                    }
                }
            } catch (error) {
                console.error('Sync error:', error);
            }
        }
        
        // Sync sermon update to Supabase
        async function syncSermonUpdateToSupabase(sermonIndex) {
            if (!supabase) return;
            
            const sermon = sermons[sermonIndex];
            if (!sermon || !sermon.id || sermon.id < 10001) return;  // Only update synced sermons
            
            try {
                const dateStr = sermon.date instanceof Date 
                    ? sermon.date.toISOString().split('T')[0]
                    : sermon.date.split('T')[0];
                
                const { error } = await supabase
                    .from('sermons')
                    .update({
                        title: sermon.title,
                        tamil_title: sermon.tamilTitle || null,
                        sermon_date: dateStr,
                        verses: sermon.verses || []
                    })
                    .eq('id', sermon.id);
                
                if (error) {
                    console.error('Error updating sermon in Supabase:', error);
                } else {
                    console.log('Successfully updated sermon in Supabase:', sermon.id);
                }
            } catch (error) {
                console.error('Sync update error:', error);
            }
        }
        
        // Sync sermon deletion to Supabase
        async function syncSermonDeleteToSupabase(sermonId) {
            if (!supabase || !sermonId) return;
            
            // Only delete from Supabase if it's a synced sermon (sequential IDs starting from 10001)
            if (sermonId < 10001) {
                console.log('Skipping Supabase delete for non-synced sermon:', sermonId);
                return;
            }
            
            try {
                console.log('Deleting sermon from Supabase:', sermonId);
                const { error } = await supabase
                    .from('sermons')
                    .delete()
                    .eq('id', sermonId);
                
                if (error) {
                    console.error('Error deleting sermon from Supabase:', error);
                } else {
                    console.log('Successfully deleted sermon from Supabase:', sermonId);
                }
            } catch (error) {
                console.error('Sync delete error:', error);
            }
        }

        // Handle double-tap on sermon card
        let lastTapTime = null;
        let lastTappedElement = null;
        
        function attachDoubleTapListener() {
            // Use event delegation on document for maximum compatibility
            document.addEventListener('click', function doubleTapHandler(e) {
                // Don't handle double-tap for verse badges - allow single click
                if (e.target.closest('.sermon-verse-clickable')) {
                    return;
                }

                const sermonItem = e.target.closest('.sermon-item');
                if (!sermonItem) return;

                const currentTime = new Date().getTime();
                const timeSinceLastTap = lastTapTime !== null ? currentTime - lastTapTime : Infinity;
                
                console.log('Click on sermon item. timeSinceLastTap:', timeSinceLastTap, 'same element:', lastTappedElement === sermonItem);

                // Check for double tap: within 500ms and on same element
                if (timeSinceLastTap < 500 && lastTappedElement === sermonItem) {
                    console.log('âœ… DOUBLE TAP DETECTED!');
                    const index = sermonItem.dataset.index;
                    console.log('Opening sermon:', index);
                    showSermonDetails(parseInt(index));
                    lastTapTime = null;
                    lastTappedElement = null;
                } else {
                    // Single tap - record this as potential first tap of double tap
                    lastTapTime = currentTime;
                    lastTappedElement = sermonItem;
                    console.log('First tap recorded');
                }
            }, { passive: true });
        }

        // Cache for preloaded verses
        let verseCache = {
            english: {},
            tamil: {},
            dual: {}
        };

        // Load and cache verses in background
        async function preloadVersesCached(book, chapter, verseStart, verseEnd, language) {
            const cacheKey = `${book}|${chapter}|${verseStart}|${verseEnd}`;
            
            // Check if already cached
            if (verseCache[language][cacheKey]) {
                return;
            }

            try {
                const bookFile = book.toLowerCase().replace(/\s+/g, '_');
                
                const { data, error } = await supabase
                    .from('bible_verses')
                    .select('verse, text')
                    .eq('book_file', bookFile)
                    .eq('chapter', chapter)
                    .eq('language', language)
                    .gte('verse', verseStart)
                    .lte('verse', verseEnd)
                    .order('verse', { ascending: true });

                if (error) {
                    console.warn(`Error preloading verses: ${error.message}`);
                    return;
                }

                // Cache the results
                if (data && data.length > 0) {
                    verseCache[language][cacheKey] = data;
                    console.log(`âœ“ Preloaded ${language} verses: ${book} ${chapter}:${verseStart}-${verseEnd}`);
                }
            } catch (error) {
                console.error('Error preloading verses:', error);
            }
        }

        // Preload all verses in background when sermon opens
        function preloadVersesInBackground(verses) {
            // Group verses by book and chapter
            const versesByBookChapter = {};

            verses.forEach(v => {
                const key = `${v.book}|${v.chapter}`;
                if (!versesByBookChapter[key]) {
                    versesByBookChapter[key] = {
                        book: v.book,
                        chapter: v.chapter,
                        verseStarts: [],
                        verseEnds: []
                    };
                }
                versesByBookChapter[key].verseStarts.push(v.verseStart);
                versesByBookChapter[key].verseEnds.push(v.verseEnd);
            });

            // Load each book/chapter combination in background
            Object.values(versesByBookChapter).forEach(group => {
                const minVerse = Math.min(...group.verseStarts);
                const maxVerse = Math.max(...group.verseEnds);
                
                // Preload English
                preloadVersesCached(group.book, group.chapter, minVerse, maxVerse, 'english');
                // Preload Tamil
                preloadVersesCached(group.book, group.chapter, minVerse, maxVerse, 'tamil');
            });
        }

        // Preload all verses from all sermons on page load
        async function preloadAllSermonsVerses() {
            if (!sermons || sermons.length === 0) return;

            // Collect all unique verse references from all sermons
            const allVerses = [];
            const verseSet = new Set();

            sermons.forEach(sermon => {
                if (sermon.verses && sermon.verses.length > 0) {
                    sermon.verses.forEach(v => {
                        const verseKey = `${v.book}|${v.chapter}|${v.verseStart}|${v.verseEnd}`;
                        if (!verseSet.has(verseKey)) {
                            verseSet.add(verseKey);
                            allVerses.push(v);
                        }
                    });
                }
            });

            // Preload all verses in background
            if (allVerses.length > 0) {
                preloadVersesInBackground(allVerses);
            }
        }

        // Show sermon details bottom sheet
        function showSermonDetails(index) {
            const sermon = sermons[index];
            const detailSheet = document.getElementById('sermon-detail-sheet');
            const detailContent = document.getElementById('sermon-detail-content');

            // Populate detail sheet
            const versesHtml = sermon.verses && sermon.verses.length > 0
                ? sermon.verses.map(v => `<span class="sermon-verse-badge sermon-verse-clickable" onclick="openVerseInBible('${v.book}', ${v.chapter}, ${v.verseStart}, ${v.verseEnd})" style="cursor: pointer;">${v.display}</span>`).join('')
                : 'No verses added';

            // Build action buttons based on admin status
            const adminButtons = isAdmin() ? `
                <button class="sermon-detail-btn sermon-detail-edit" onclick="editSermon(${index})">Edit</button>
                <button class="sermon-detail-btn sermon-detail-delete" onclick="deleteSermonWithConfirm(${index})">Delete</button>
            ` : '';

            // Build detail content with optional actions section
            const actionsSection = isAdmin() ? `
                <div class="sermon-detail-actions">
                    ${adminButtons}
                </div>
            ` : '';

            // Add Show All link
            const showAllLink = sermon.verses && sermon.verses.length > 0 ? `<a class="sermon-show-all-link" onclick="showAllVerses(${index})" style="cursor: pointer;">Show All</a>` : '';

            detailContent.innerHTML = `
                <div class="sermon-detail-section">
                    <div class="sermon-verses-header">
                        <h3>Verses</h3>
                        ${showAllLink}
                    </div>
                    <div class="sermon-detail-verses">${versesHtml}</div>
                </div>
                ${actionsSection}
            `;

            // Update header with title and date
            const detailHeader = document.getElementById('sermon-detail-header');
            const dateStr = formatSermonDate(new Date(sermon.date));
            detailHeader.innerHTML = `
                <div style="flex: 1;">
                    <h2 class="sermon-sheet-title" style="margin: 0; font-size: 1.1rem;">${sermon.title}</h2>
                    ${sermon.tamilTitle ? `<p style="margin: 0.25rem 0 0 0; font-size: 0.75rem; color: #666; font-weight: 500;">${sermon.tamilTitle}</p>` : ''}
                </div>
            `;

            detailSheet.classList.add('active');
            detailSheet.classList.add('show-close');
            detailSheet.dataset.openSermonIndex = index;  // Track which sermon is open
            detailSheet.style.maxHeight = '80vh';  // Reset maxHeight to default
            detailSheet.style.transition = 'transform 0.3s ease';  // Re-enable transitions
            
            // Remove active class from all sermon items
            document.querySelectorAll('.sermon-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active class to clicked sermon item
            const sermonItem = document.querySelector(`[data-index="${index}"]`);
            if (sermonItem) {
                sermonItem.classList.add('active');
            }
            
            // Show overlay
            const detailOverlay = document.getElementById('sermon-detail-overlay');
            if (detailOverlay) {
                detailOverlay.classList.add('active');
            }
            
            // Add blur to container
            const container = document.querySelector('.sermon-container');
            if (container) {
                container.classList.add('blurred');
            }

            // Preload all verses in background for faster access
            if (sermon.verses && sermon.verses.length > 0) {
                preloadVersesInBackground(sermon.verses);
            }
        }

        // Close sermon details
        function closeSermonDetail() {
            const detailSheet = document.getElementById('sermon-detail-sheet');
            const detailOverlay = document.getElementById('sermon-detail-overlay');
            detailSheet.classList.remove('active');
            detailSheet.classList.remove('show-close');
            if (detailOverlay) {
                detailOverlay.classList.remove('active');
            }
            detailSheet.dataset.openSermonIndex = null;  // Clear tracking
            
            // Remove active class from all sermon items
            document.querySelectorAll('.sermon-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Remove blur from container
            const container = document.querySelector('.sermon-container');
            if (container) {
                container.classList.remove('blurred');
            }
        }
        
        // Add overlay click handler for better cross-browser support
        document.addEventListener('DOMContentLoaded', () => {
            const detailOverlay = document.getElementById('sermon-detail-overlay');
            const detailSheet = document.getElementById('sermon-detail-sheet');
            
            if (detailOverlay) {
                detailOverlay.addEventListener('click', (e) => {
                    console.log('Overlay clicked, target:', e.target, 'overlay:', detailOverlay);
                    // Close on any click on the overlay
                    closeSermonDetail();
                });
            }
            
            // Prevent clicks inside the sheet from closing it
            if (detailSheet) {
                detailSheet.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
            }
        });

        // Edit sermon
        function editSermon(index) {
            const sermon = sermons[index];
            // Pre-fill the form with sermon data
            document.getElementById('sermon-title-input').value = sermon.title;
            document.getElementById('sermon-tamil-title-input').value = sermon.tamilTitle || '';
            selectedSermonDate = sermon.date;
            document.getElementById('sermon-date-display').textContent = formatSermonDate(new Date(sermon.date));
            selectedSermonVerses = [...sermon.verses];
            currentEditingIndex = index;
            renderVersesChips();
            closeSermonDetail();
            document.getElementById('sermon-bottom-sheet').classList.add('active');
            document.getElementById('sermon-sheet-overlay').classList.add('active');
        }

        let currentEditingIndex = null;

        // Open verse in modal popup
        // Map book names to database book_file identifiers
        function getBookFileIdentifier(bookName) {
            const bookMapping = {
                '1 Corinthians': 'i_corinthians',
                '2 Corinthians': 'ii_corinthians',
                '1 Kings': 'i_kings',
                '2 Kings': 'ii_kings',
                '1 Chronicles': 'i_chronicles',
                '2 Chronicles': 'ii_chronicles',
                '1 Samuel': 'i_samuel',
                '2 Samuel': 'ii_samuel',
                '1 Thessalonians': 'i_thessalonians',
                '2 Thessalonians': 'ii_thessalonians',
                '1 Timothy': 'i_timothy',
                '2 Timothy': 'ii_timothy',
                '1 Peter': 'i_peter',
                '2 Peter': 'ii_peter',
                '1 John': 'i_john',
                '2 John': 'ii_john',
                '3 John': 'iii_john',
                '1 Thessalonians': 'i_thessalonians',
                '2 Thessalonians': 'ii_thessalonians'
            };
            
            // Return mapped value if exists, otherwise convert to lowercase with underscores
            return bookMapping[bookName] || bookName.toLowerCase().replace(/\s+/g, '_');
        }

        function openVerseInBible(book, chapter, verseStart, verseEnd) {
            const verseRef = `${book} ${chapter}:${verseStart}${verseStart !== verseEnd ? '-' + verseEnd : ''}`;
            
            // Load and display the verse from cache or Supabase
            loadVersesFromSupabaseSermon(book, chapter, verseStart, verseEnd, verseRef);
        }

        // Load verses from cache or Supabase and display in modal
        async function loadVersesFromSupabaseSermon(book, chapter, verseStart, verseEnd, verseRef) {
            const badge = document.getElementById('passageBadge');
            const content = document.getElementById('passageContent');
            
            if (!badge || !content) return;

            // Store for language switching
            currentSermonVerseRef = verseRef;
            currentSermonVerseStart = verseStart;
            currentSermonVerseEnd = verseEnd;
            currentSermonBook = book;
            currentSermonChapter = chapter;

            // Show loader
            content.innerHTML = '<div class="passage-loader"><div class="passage-loader-spinner"></div></div>';
            
            // Reset language buttons to Tamil (default)
            const buttons = document.querySelectorAll('.passage-lang-btn');
            buttons.forEach(btn => {
                if (btn.dataset.lang === 'tamil') {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            try {
                const bookFile = getBookFileIdentifier(book);
                const cacheKey = `${book}|${chapter}|${verseStart}|${verseEnd}`;
                
                // Check cache first for Tamil
                let data = verseCache.tamil[cacheKey];
                
                // If not in cache, fetch Tamil from Supabase
                if (!data) {
                    const { data: fetchedData, error } = await supabase
                        .from('bible_verses')
                        .select('verse, text')
                        .eq('book_file', bookFile)
                        .eq('chapter', chapter)
                        .eq('language', 'tamil')
                        .gte('verse', verseStart)
                        .lte('verse', verseEnd)
                        .order('verse', { ascending: true });

                    if (error) {
                        throw error;
                    }
                    data = fetchedData;
                    
                    // Cache the result for future use
                    if (data && data.length > 0) {
                        verseCache.tamil[cacheKey] = data;
                    }
                }

                if (!data || data.length === 0) {
                    // No Tamil data found, try English
                    let engData = verseCache.english[cacheKey];
                    
                    if (!engData) {
                        const { data: fetchedData, error } = await supabase
                            .from('bible_verses')
                            .select('verse, text')
                            .eq('book_file', bookFile)
                            .eq('chapter', chapter)
                            .eq('language', 'english')
                            .gte('verse', verseStart)
                            .lte('verse', verseEnd)
                            .order('verse', { ascending: true });

                        if (error) {
                            throw error;
                        }
                        engData = fetchedData;
                        if (engData && engData.length > 0) {
                            verseCache.english[cacheKey] = engData;
                        }
                    }

                    if (!engData || engData.length === 0) {
                        // No data found
                        badge.textContent = verseRef;
                        content.innerHTML = '<p class="passage-no-data">Data yet to be seeded</p>';
                        setTimeout(() => {
                            content.style.opacity = '1';
                        }, 50);
                    } else {
                        // Display English if Tamil not available
                        buttons.forEach(btn => {
                            if (btn.dataset.lang === 'english') {
                                btn.classList.add('active');
                            } else {
                                btn.classList.remove('active');
                            }
                        });
                        
                        let htmlContent = '';
                        engData.forEach(row => {
                            htmlContent += `<p class="bible-verse">${row.verse}. ${row.text}</p>`;
                        });

                        badge.textContent = verseRef;
                        content.innerHTML = htmlContent;
                        content.scrollTop = 0;
                        
                        setTimeout(() => {
                            content.style.opacity = '1';
                        }, 50);
                    }
                } else {
                    // Format and display the Tamil verses
                    let htmlContent = '';
                    data.forEach(row => {
                        htmlContent += `<p class="tamil-verse">${row.verse}. ${row.text}</p>`;
                    });

                    badge.textContent = verseRef;
                    content.innerHTML = htmlContent;
                    content.scrollTop = 0;
                    
                    setTimeout(() => {
                        content.style.opacity = '1';
                    }, 50);
                }

                // Open the modal
                const modal = document.getElementById('passagePopup');
                const modalCard = document.getElementById('passageModalCard');
                if (modal) {
                    // Reset modal card styles
                    if (modalCard) {
                        modalCard.style.maxHeight = '85vh';
                        modalCard.style.transition = 'max-height 0.3s ease';
                    }
                    modal.classList.add('show');
                    document.body.classList.add('modal-open');
                    // Initialize drag functionality
                    setTimeout(() => initPassageModalDrag(), 100);
                }

            } catch (error) {
                console.error('Error loading verses:', error);
                badge.textContent = verseRef;
                content.innerHTML = '<p class="passage-no-data">Error loading verse. Please try again.</p>';
                
                // Open the modal anyway to show error
                const modal = document.getElementById('passagePopup');
                const modalCard = document.getElementById('passageModalCard');
                if (modal) {
                    // Reset modal card styles
                    if (modalCard) {
                        modalCard.style.maxHeight = '85vh';
                        modalCard.style.transition = 'max-height 0.3s ease';
                    }
                    modal.classList.add('show');
                    document.body.classList.add('modal-open');
                    // Initialize drag functionality
                    setTimeout(() => initPassageModalDrag(), 100);
                }
            }
        }

        // Show all verses from a sermon in the passage modal
        async function showAllVerses(sermonIndex) {
            const sermon = sermons[sermonIndex];
            if (!sermon || !sermon.verses || sermon.verses.length === 0) return;

            const badge = document.getElementById('passageBadge');
            const content = document.getElementById('passageContent');
            const modal = document.getElementById('passagePopup');
            const modalCard = document.getElementById('passageModalCard');

            if (!badge || !content || !modal) return;

            // Set title
            badge.textContent = `All Verses - ${sermon.title}`;

            // Set flags for "Show All" mode
            isShowAllMode = true;
            currentSermonAllVerses = sermon.verses;

            // Show loader
            content.innerHTML = '<div class="passage-loader"><div class="passage-loader-spinner"></div></div>';

            // Reset language buttons
            const buttons = document.querySelectorAll('.passage-lang-btn');
            buttons.forEach(btn => {
                if (btn.dataset.lang === 'tamil') {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            try {
                let htmlContent = '';

                // Load each verse with title and separator
                for (let i = 0; i < sermon.verses.length; i++) {
                    const verse = sermon.verses[i];
                    const verseTitle = `${verse.book} ${verse.chapter}:${verse.verseStart}${verse.verseStart !== verse.verseEnd ? '-' + verse.verseEnd : ''}`;

                    // Fetch verse text from Supabase
                    const bookFile = getBookFileIdentifier(verse.book);
                    const cacheKey = `${verse.book}|${verse.chapter}|${verse.verseStart}|${verse.verseEnd}`;

                    // Try Tamil first
                    let data = verseCache.tamil[cacheKey];
                    if (!data) {
                        const { data: fetchedData } = await supabase
                            .from('bible_verses')
                            .select('verse, text')
                            .eq('book_file', bookFile)
                            .eq('chapter', verse.chapter)
                            .eq('language', 'tamil')
                            .gte('verse', verse.verseStart)
                            .lte('verse', verse.verseEnd)
                            .order('verse', { ascending: true });

                        data = fetchedData;
                        if (data && data.length > 0) {
                            verseCache.tamil[cacheKey] = data;
                        }
                    }

                    // If no Tamil, try English
                    if (!data || data.length === 0) {
                        let engData = verseCache.english[cacheKey];
                        if (!engData) {
                            const { data: fetchedData } = await supabase
                                .from('bible_verses')
                                .select('verse, text')
                                .eq('book_file', bookFile)
                                .eq('chapter', verse.chapter)
                                .eq('language', 'english')
                                .gte('verse', verse.verseStart)
                                .lte('verse', verse.verseEnd)
                                .order('verse', { ascending: true });

                            engData = fetchedData;
                            if (engData && engData.length > 0) {
                                verseCache.english[cacheKey] = engData;
                            }
                        }
                        data = engData;
                    }

                    // Add separator before verse (except for first verse)
                    if (i > 0) {
                        htmlContent += `<hr class="verse-separator" />`;
                    }

                    // Add verse title
                    htmlContent += `<div class="verse-title-divider">
                        <h4 class="verse-title"><span class="sermon-verse-badge">${verseTitle}</span></h4>
                    </div>`;

                    // Add verse content
                    if (data && data.length > 0) {
                        data.forEach(row => {
                            htmlContent += `<p class="tamil-verse"><span class="passage-verse-badge">${row.verse}</span> ${row.text}</p>`;
                        });
                    } else {
                        htmlContent += `<p class="passage-no-data">Verse not found</p>`;
                    }
                }

                content.innerHTML = htmlContent;
                content.scrollTop = 0;

                // Open modal
                if (modalCard) {
                    modalCard.style.maxHeight = '85vh';
                    modalCard.style.transition = 'max-height 0.3s ease';
                }
                modal.classList.add('show');
                document.body.classList.add('modal-open');

                // Initialize drag functionality
                setTimeout(() => initPassageModalDrag(), 100);

            } catch (error) {
                console.error('Error loading all verses:', error);
                content.innerHTML = '<p class="passage-no-data">Error loading verses. Please try again.</p>';
                modal.classList.add('show');
                document.body.classList.add('modal-open');
            }
        }

        // Close passage popup modal
        function closePassagePopupSermon() {
            const modal = document.getElementById('passagePopup');
            if (modal) {
                modal.classList.remove('show');
                document.body.classList.remove('modal-open');
            }
            // Reset Show All mode flag
            isShowAllMode = false;
            currentSermonAllVerses = null;
        }

        // Handle click outside the modal card to close
        function handlePassagePopupClick(event) {
            const modal = document.getElementById('passagePopup');
            const modalCard = document.getElementById('passageModalCard');
            
            // Close if clicking outside the modal card
            if (modal && event.target === modal) {
                closePassagePopupSermon();
            }
        }

        // Draggable header for passage modal
        let passageDragStartY = 0;
        let passageDragStartHeight = 0;

        function initPassageModalDrag() {
            const header = document.getElementById('passageHeaderDrag');
            const modalCard = document.getElementById('passageModalCard');
            
            if (!header) return;

            // Remove old event listeners to prevent duplicates
            const newHeader = header.cloneNode(true);
            header.parentNode.replaceChild(newHeader, header);
            const updatedHeader = document.getElementById('passageHeaderDrag');

            updatedHeader.addEventListener('touchstart', (e) => {
                passageDragStartY = e.touches[0].clientY;
                passageDragStartHeight = modalCard.offsetHeight;
                modalCard.style.transition = 'none';
            }, false);

            updatedHeader.addEventListener('touchmove', (e) => {
                const currentY = e.touches[0].clientY;
                const diff = passageDragStartY - currentY;
                const newHeight = passageDragStartHeight + diff;
                const maxHeight = window.innerHeight * 0.95;
                const minHeight = 200;

                if (newHeight >= minHeight && newHeight <= maxHeight) {
                    modalCard.style.maxHeight = newHeight + 'px';
                }
            }, false);

            updatedHeader.addEventListener('touchend', (e) => {
                modalCard.style.transition = 'max-height 0.3s ease';
                const currentHeight = modalCard.offsetHeight;
                const maxHeight = window.innerHeight * 0.95;
                const threshold = maxHeight * 0.3;

                if (currentHeight < threshold) {
                    // Close if dragged down below threshold
                    closePassagePopupSermon();
                } else {
                    // Reset to max height
                    modalCard.style.maxHeight = '85vh';
                }
            }, false);
        }

        // Track current verse reference for language switching
        let currentSermonVerseRef = '';
        let currentSermonVerseStart = 0;
        let currentSermonVerseEnd = 0;
        let currentSermonBook = '';
        let currentSermonChapter = 0;
        let currentSermonAllVerses = null;  // Track all verses for "Show All" mode
        let isShowAllMode = false;  // Flag to track if we're in "Show All" view

        // Switch passage language (English, Tamil, or Dual)
        async function switchPassageLanguageSermon(language) {
            // Update active button
            const buttons = document.querySelectorAll('.passage-lang-btn');
            buttons.forEach(btn => {
                if (btn.dataset.lang === language) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            const content = document.getElementById('passageContent');
            if (!content) return;

            // Show loader
            content.innerHTML = '<div class="passage-loader"><div class="passage-loader-spinner"></div></div>';

            // Handle "Show All" mode differently
            if (isShowAllMode && currentSermonAllVerses && currentSermonAllVerses.length > 0) {
                try {
                    let htmlContent = '';

                    // Load each verse with title and separator
                    for (let i = 0; i < currentSermonAllVerses.length; i++) {
                        const verse = currentSermonAllVerses[i];
                        const verseTitle = `${verse.book} ${verse.chapter}:${verse.verseStart}${verse.verseStart !== verse.verseEnd ? '-' + verse.verseEnd : ''}`;
                        const bookFile = getBookFileIdentifier(verse.book);
                        const cacheKey = `${verse.book}|${verse.chapter}|${verse.verseStart}|${verse.verseEnd}`;

                        if (language === 'dual') {
                            // Load both English and Tamil
                            let engData = verseCache.english[cacheKey];
                            let tamData = verseCache.tamil[cacheKey];

                            if (!engData) {
                                const { data } = await supabase
                                    .from('bible_verses')
                                    .select('verse, text')
                                    .eq('book_file', bookFile)
                                    .eq('chapter', verse.chapter)
                                    .eq('language', 'english')
                                    .gte('verse', verse.verseStart)
                                    .lte('verse', verse.verseEnd)
                                    .order('verse', { ascending: true });
                                engData = data;
                                if (data) verseCache.english[cacheKey] = data;
                            }

                            if (!tamData) {
                                const { data } = await supabase
                                    .from('bible_verses')
                                    .select('verse, text')
                                    .eq('book_file', bookFile)
                                    .eq('chapter', verse.chapter)
                                    .eq('language', 'tamil')
                                    .gte('verse', verse.verseStart)
                                    .lte('verse', verse.verseEnd)
                                    .order('verse', { ascending: true });
                                tamData = data;
                                if (data) verseCache.tamil[cacheKey] = data;
                            }

                            // Add separator before verse (except for first verse)
                            if (i > 0) {
                                htmlContent += `<hr class="verse-separator" />`;
                            }

                            // Add verse title
                            htmlContent += `<div class="verse-title-divider">
                                <h4 class="verse-title"><span class="sermon-verse-badge">${verseTitle}</span></h4>
                            </div>`;

                            // Add both language versions
                            if ((engData && engData.length > 0) || (tamData && tamData.length > 0)) {
                                engData && engData.forEach(row => {
                                    htmlContent += `<p class="bible-verse"><span class="passage-verse-badge">${row.verse}</span> ${row.text}</p>`;
                                });
                                // Add divider between languages only if both exist
                                if (engData && engData.length > 0 && tamData && tamData.length > 0) {
                                    htmlContent += `<hr class="verse-separator" />`;
                                }
                                tamData && tamData.forEach(row => {
                                    htmlContent += `<p class="tamil-verse"><span class="passage-verse-badge">${row.verse}</span> ${row.text}</p>`;
                                });
                            } else {
                                htmlContent += `<p class="passage-no-data">Verse not found</p>`;
                            }
                        } else {
                            // Load single language
                            const langCode = language === 'tamil' ? 'tamil' : 'english';
                            let data = verseCache[langCode][cacheKey];

                            if (!data) {
                                const { data: fetchedData } = await supabase
                                    .from('bible_verses')
                                    .select('verse, text')
                                    .eq('book_file', bookFile)
                                    .eq('chapter', verse.chapter)
                                    .eq('language', langCode)
                                    .gte('verse', verse.verseStart)
                                    .lte('verse', verse.verseEnd)
                                    .order('verse', { ascending: true });
                                data = fetchedData;
                                if (fetchedData) verseCache[langCode][cacheKey] = fetchedData;
                            }

                            // Add verse title
                            htmlContent += `<div class="verse-title-divider">
                                <h4 class="verse-title"><span class="sermon-verse-badge">${verseTitle}</span></h4>
                            </div>`;

                            // Add verse content
                            if (data && data.length > 0) {
                                data.forEach(row => {
                                    const className = language === 'tamil' ? 'tamil-verse' : 'bible-verse';
                                    htmlContent += `<p class="${className}"><span class="passage-verse-badge">${row.verse}</span> ${row.text}</p>`;
                                });
                            } else {
                                htmlContent += `<p class="passage-no-data">Verse not found</p>`;
                            }
                        }

                        // Add separator before next verse (except for last verse)
                        if (i < currentSermonAllVerses.length - 1) {
                            htmlContent += `<hr class="verse-separator" />`;
                        }
                    }

                    content.innerHTML = htmlContent;
                    content.scrollTop = 0;

                } catch (error) {
                    console.error('Error loading verses:', error);
                    content.innerHTML = '<p class="passage-no-data">Error loading verses. Please try again.</p>';
                }
                return;
            }

            try {
                const bookFile = getBookFileIdentifier(currentSermonBook);
                const cacheKey = `${currentSermonBook}|${currentSermonChapter}|${currentSermonVerseStart}|${currentSermonVerseEnd}`;

                if (language === 'dual') {
                    // Load both English and Tamil from cache or Supabase
                    let engData = verseCache.english[cacheKey];
                    let tamData = verseCache.tamil[cacheKey];

                    // Fetch if not in cache
                    if (!engData) {
                        const { data } = await supabase
                            .from('bible_verses')
                            .select('verse, text')
                            .eq('book_file', bookFile)
                            .eq('chapter', currentSermonChapter)
                            .eq('language', 'english')
                            .gte('verse', currentSermonVerseStart)
                            .lte('verse', currentSermonVerseEnd)
                            .order('verse', { ascending: true });
                        engData = data;
                        if (data) verseCache.english[cacheKey] = data;
                    }

                    if (!tamData) {
                        const { data } = await supabase
                            .from('bible_verses')
                            .select('verse, text')
                            .eq('book_file', bookFile)
                            .eq('chapter', currentSermonChapter)
                            .eq('language', 'tamil')
                            .gte('verse', currentSermonVerseStart)
                            .lte('verse', currentSermonVerseEnd)
                            .order('verse', { ascending: true });
                        tamData = data;
                        if (data) verseCache.tamil[cacheKey] = data;
                    }

                    let dualHtml = '';
                    const engVerses = engData || [];
                    const tamVerses = tamData || [];

                    // Combine both languages
                    const maxVerse = Math.max(
                        engVerses.length > 0 ? Math.max(...engVerses.map(v => v.verse)) : 0,
                        tamVerses.length > 0 ? Math.max(...tamVerses.map(v => v.verse)) : 0
                    );

                    for (let i = currentSermonVerseStart; i <= maxVerse; i++) {
                        const engVerse = engVerses.find(v => v.verse === i);
                        const tamVerse = tamVerses.find(v => v.verse === i);

                        if (engVerse || tamVerse) {
                            dualHtml += '<div class="dual-verse-container">';
                            if (engVerse) {
                                dualHtml += `<p class="bible-verse">${engVerse.verse}. ${engVerse.text}</p>`;
                            }
                            if (tamVerse) {
                                dualHtml += `<p class="tamil-verse">${tamVerse.verse}. ${tamVerse.text}</p>`;
                            }
                            dualHtml += '</div>';
                        }
                    }

                    content.innerHTML = dualHtml || '<p class="passage-no-data">Translations not available</p>';
                } else {
                    // Load single language
                    const langCode = language === 'tamil' ? 'tamil' : 'english';
                    let data = verseCache[langCode][cacheKey];

                    // Fetch if not in cache
                    if (!data) {
                        const { data: fetchedData, error } = await supabase
                            .from('bible_verses')
                            .select('verse, text')
                            .eq('book_file', bookFile)
                            .eq('chapter', currentSermonChapter)
                            .eq('language', langCode)
                            .gte('verse', currentSermonVerseStart)
                            .lte('verse', currentSermonVerseEnd)
                            .order('verse', { ascending: true });

                        if (error) throw error;
                        data = fetchedData;
                        if (data) verseCache[langCode][cacheKey] = data;
                    }

                    if (!data || data.length === 0) {
                        content.innerHTML = `<p class="passage-no-data">${language === 'tamil' ? 'Tamil' : 'English'} translation not available</p>`;
                    } else {
                        let htmlContent = '';
                        const className = language === 'tamil' ? 'tamil-verse' : 'bible-verse';
                        data.forEach(row => {
                            htmlContent += `<p class="${className}">${row.verse}. ${row.text}</p>`;
                        });
                        content.innerHTML = htmlContent;
                    }
                }

                content.scrollTop = 0;
                setTimeout(() => {
                    content.style.opacity = '1';
                }, 50);

            } catch (error) {
                console.error('Error switching language:', error);
                content.innerHTML = `<p class="passage-no-data">Error loading ${language} translation. Please try again.</p>`;
            }
        }

        // Delete sermon with confirmation
        function deleteSermonWithConfirm(index) {
            const confirmDialog = document.getElementById('sermon-confirm-dialog');
            const confirmBackdrop = document.getElementById('sermon-confirm-backdrop');
            const confirmMessage = document.getElementById('sermon-confirm-message');

            confirmMessage.textContent = 'Are you sure you want to delete this sermon?';
            confirmDialog.classList.add('active');
            confirmBackdrop.classList.add('active');

            // Store the index to delete
            confirmDialog.dataset.deleteIndex = index;
        }

        // Cancel confirm dialog
        function cancelConfirmDialog() {
            const confirmDialog = document.getElementById('sermon-confirm-dialog');
            const confirmBackdrop = document.getElementById('sermon-confirm-backdrop');
            confirmDialog.classList.remove('active');
            confirmBackdrop.classList.remove('active');
        }

        // Confirm delete
        function confirmDelete() {
            const confirmDialog = document.getElementById('sermon-confirm-dialog');
            const index = parseInt(confirmDialog.dataset.deleteIndex);
            const sermonToDelete = sermons[index];
            
            // Sync deletion to Supabase
            if (sermonToDelete.id) {
                syncSermonDeleteToSupabase(sermonToDelete.id);
            }
            
            sermons.splice(index, 1);
            saveSermons();
            renderSermons();
            cancelConfirmDialog();
            closeSermonDetail();
        }

        // Calendar functions
        function renderSermonCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();

            // Update title
            const options = { year: 'numeric', month: 'long' };
            document.getElementById('sermon-calendar-title').textContent =
                currentCalendarDate.toLocaleDateString('en-US', options);

            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, month, 0).getDate();

            const grid = document.getElementById('sermon-calendar-grid');
            grid.innerHTML = '';

            // Weekday headers
            const weekdays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            weekdays.forEach(day => {
                const dayEl = document.createElement('div');
                dayEl.className = 'sermon-calendar-weekday';
                dayEl.textContent = day;
                grid.appendChild(dayEl);
            });

            // Previous month days
            for (let i = firstDay - 1; i >= 0; i--) {
                const dayEl = document.createElement('div');
                dayEl.className = 'sermon-calendar-day other-month';
                dayEl.textContent = daysInPrevMonth - i;
                grid.appendChild(dayEl);
            }

            // Current month days
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'sermon-calendar-day';
                dayEl.textContent = day;

                const currentDate = new Date(year, month, day);

                // Check if today
                if (currentDate.toDateString() === today.toDateString()) {
                    dayEl.classList.add('today');
                }

                // Check if selected
                if (selectedSermonDate && currentDate.toDateString() === selectedSermonDate.toDateString()) {
                    dayEl.classList.add('selected');
                }

                dayEl.addEventListener('click', () => {
                    selectedSermonDate = currentDate;
                    const dateStr = currentDate.toLocaleDateString();
                    document.getElementById('sermon-date-display').textContent = dateStr;
                    document.getElementById('sermon-date-input').value = currentDate.toISOString();
                    
                    // Clear error when date is selected
                    const dateGroup = datePickerBtn.closest('.sermon-input-group');
                    if (dateGroup) {
                        dateGroup.classList.remove('error');
                    }
                    
                    closeSermonCalendar();
                });

                grid.appendChild(dayEl);
            }

            // Next month days
            const totalCells = grid.children.length - 7; // Subtract weekday headers
            const remainingCells = 42 - totalCells; // 6 rows * 7 days
            for (let day = 1; day <= remainingCells; day++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'sermon-calendar-day other-month';
                dayEl.textContent = day;
                grid.appendChild(dayEl);
            }
        }

        function prevSermonMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            renderSermonCalendar();
        }

        function nextSermonMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            renderSermonCalendar();
        }

        function openSermonCalendar() {
            currentCalendarDate = selectedSermonDate ? new Date(selectedSermonDate) : new Date();
            renderSermonCalendar();
            document.getElementById('sermon-calendar-backdrop').classList.add('show');
            document.getElementById('sermon-calendar-modal').classList.add('show');
        }

        function closeSermonCalendar() {
            document.getElementById('sermon-calendar-backdrop').classList.remove('show');
            document.getElementById('sermon-calendar-modal').classList.remove('show');
        }

        // Bottom sheet functionality
        const addBtn = document.getElementById('sermon-add-btn');
        const cancelBtn = document.getElementById('sermon-btn-cancel');
        const saveBtn = document.getElementById('sermon-btn-save');
        const overlay = document.getElementById('sermon-sheet-overlay');
        const bottomSheet = document.getElementById('sermon-bottom-sheet');
        const titleInput = document.getElementById('sermon-title-input');
        const datePickerBtn = document.getElementById('sermon-date-picker-btn');

        // Clear error on title input
        titleInput.addEventListener('input', () => {
            if (titleInput.value.trim()) {
                const titleGroup = titleInput.closest('.sermon-input-group');
                titleGroup.classList.remove('error');
            }
        });

        // Clear error on date selection
        const originalDatePickerClick = datePickerBtn.onclick;
        datePickerBtn.addEventListener('click', () => {
            if (selectedSermonDate) {
                const dateGroup = datePickerBtn.closest('.sermon-input-group');
                dateGroup.classList.remove('error');
            }
        });

        // Open bottom sheet
        addBtn.addEventListener('click', () => {
            titleInput.value = '';
            document.getElementById('sermon-tamil-title-input').value = '';
            selectedSermonDate = null;
            selectedSermonVerses = [];
            document.getElementById('sermon-date-display').textContent = 'Select date';
            document.getElementById('sermon-date-input').value = '';
            document.getElementById('sermon-book-select').value = '';
            document.getElementById('sermon-chapter-select').value = '';
            document.getElementById('sermon-chapter-select').disabled = true;
            document.getElementById('sermon-verses-select').value = '';
            document.getElementById('sermon-verses-select').disabled = true;
            document.getElementById('sermon-add-verse-btn').disabled = true;
            renderVersesChips();
            overlay.classList.add('active');
            bottomSheet.classList.add('active');
            titleInput.focus();
        });

        // Date picker button
        datePickerBtn.addEventListener('click', (e) => {
            e.preventDefault();
            openSermonCalendar();
        });

        // Close bottom sheet
        function closeBottomSheet() {
            overlay.classList.remove('active');
            bottomSheet.classList.remove('active');
            // Reset form state and drag height
            currentEditingIndex = null;
            selectedSermonDate = null;
            selectedSermonVerses = [];
            renderVersesChips();
            titleInput.value = '';
            document.getElementById('sermon-tamil-title-input').value = '';
            document.getElementById('sermon-date-display').textContent = 'Select date';
            document.getElementById('sermon-book-select').value = '';
            document.getElementById('sermon-chapter-select').value = '';
            document.getElementById('sermon-verses-select').value = '';
            bottomSheet.style.maxHeight = '80vh';
        }

        // Drag to expand/collapse functionality
        let dragStartY = 0;
        let dragStartHeight = 0;
        const dragHandle = document.getElementById('sermon-sheet-drag-handle');

        dragHandle.addEventListener('touchstart', (e) => {
            dragStartY = e.touches[0].clientY;
            dragStartHeight = bottomSheet.offsetHeight;
            bottomSheet.style.transition = 'none';
        }, false);

        dragHandle.addEventListener('touchmove', (e) => {
            const currentY = e.touches[0].clientY;
            const diff = dragStartY - currentY;
            const newHeight = dragStartHeight + diff;
            const maxHeight = window.innerHeight * 0.95;
            const minHeight = 250;

            if (newHeight >= minHeight && newHeight <= maxHeight) {
                bottomSheet.style.maxHeight = newHeight + 'px';
            }
        }, false);

        dragHandle.addEventListener('touchend', (e) => {
            bottomSheet.style.transition = 'transform 0.3s ease';
            const currentHeight = bottomSheet.offsetHeight;
            const maxHeight = window.innerHeight * 0.95;
            const threshold = maxHeight * 0.4;

            if (currentHeight < threshold) {
                closeBottomSheet();
            } else {
                bottomSheet.style.maxHeight = '80vh';
            }
        }, false);

        // Drag to expand/collapse functionality for detail sheet
        let detailDragStartY = 0;
        let detailDragStartHeight = 0;
        const detailSheet = document.getElementById('sermon-detail-sheet');
        const detailSheetHandle = detailSheet.querySelector('.sermon-sheet-handle');
        const detailSheetHeader = document.getElementById('sermon-detail-header');

        // Create a combined touch handler for both handle and header
        function initializeDetailSheetDrag() {
            [detailSheetHandle, detailSheetHeader].forEach(element => {
                if (!element) return;
                
                element.addEventListener('touchstart', (e) => {
                    detailDragStartY = e.touches[0].clientY;
                    detailDragStartHeight = detailSheet.offsetHeight;
                    detailSheet.style.transition = 'none';
                }, false);

                element.addEventListener('touchmove', (e) => {
                    const currentY = e.touches[0].clientY;
                    const diff = detailDragStartY - currentY;
                    const newHeight = detailDragStartHeight + diff;
                    const maxHeight = window.innerHeight * 0.95;
                    const minHeight = 250;

                    if (newHeight >= minHeight && newHeight <= maxHeight) {
                        detailSheet.style.maxHeight = newHeight + 'px';
                    }
                }, false);

                element.addEventListener('touchend', (e) => {
                    detailSheet.style.transition = 'transform 0.3s ease';
                    const currentHeight = detailSheet.offsetHeight;
                    const maxHeight = window.innerHeight * 0.95;
                    const threshold = maxHeight * 0.4;

                    if (currentHeight < threshold) {
                        closeSermonDetail();
                    } else {
                        detailSheet.style.maxHeight = '80vh';
                    }
                }, false);
            });
        }

        // Initialize detail sheet drag
        initializeDetailSheetDrag();

        cancelBtn.addEventListener('click', closeBottomSheet);
        overlay.addEventListener('click', closeBottomSheet);

        // Save sermon
        saveBtn.addEventListener('click', () => {
            const title = titleInput.value.trim();
            const tamilTitle = document.getElementById('sermon-tamil-title-input').value.trim();
            
            // Clear previous error states
            document.querySelectorAll('.sermon-input-group').forEach(group => {
                group.classList.remove('error');
            });
            
            let isValid = true;
            
            // Validate title
            if (!title) {
                const titleGroup = titleInput.closest('.sermon-input-group');
                titleGroup.classList.add('error');
                isValid = false;
            }
            
            // Validate date
            if (!selectedSermonDate) {
                const dateGroup = datePickerBtn.closest('.sermon-input-group');
                dateGroup.classList.add('error');
                isValid = false;
            }
            
            if (!isValid) {
                return;
            }

            // Convert to ISO string if it's a Date object
            const dateIso = selectedSermonDate instanceof Date 
                ? selectedSermonDate.toISOString() 
                : selectedSermonDate;

            if (currentEditingIndex !== null) {
                // Update existing sermon
                const updatedSermon = {
                    ...sermons[currentEditingIndex],
                    title: title,
                    tamilTitle: tamilTitle || '',
                    date: dateIso,
                    verses: selectedSermonVerses
                };
                sermons[currentEditingIndex] = updatedSermon;
                
                // Sync update to Supabase for synced sermons (ID >= 10001)
                if (updatedSermon.id && updatedSermon.id >= 10001) {
                    syncSermonUpdateToSupabase(currentEditingIndex);
                }
                
                currentEditingIndex = null;
            } else {
                // Create new sermon with sequential ID
                const newSermon = {
                    id: generateSermonId(),
                    title: title,
                    tamilTitle: tamilTitle || '',
                    date: dateIso,
                    verses: selectedSermonVerses,
                    content: '', // For future use
                    _synced: false  // Mark for syncing
                };
                sermons.unshift(newSermon);
            }

            saveSermons();
            renderSermons();
            closeBottomSheet();
        });

        // Allow Enter key to save
        titleInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                saveBtn.click();
            }
        });

        // Back button functionality
        const backBtn = document.getElementById('sermon-back-btn');
        if (backBtn) {
            backBtn.addEventListener('click', () => {
                window.history.back();
            });
        }

        // Swipe back functionality
        let touchStartX = 0;
        let touchEndX = 0;
        const swipeThreshold = 50;

        document.addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].screenX;
        }, false);

        document.addEventListener('touchend', (e) => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        }, false);

        function handleSwipe() {
            if (touchStartX < 30) {
                if (touchEndX - touchStartX > swipeThreshold) {
                    window.history.back();
                }
            }
        }

        // Apply theme based on localStorage
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'light') {
            document.body.classList.remove('dark-theme');
            document.body.classList.add('light-theme');
        } else {
            document.body.classList.add('dark-theme');
            document.body.classList.remove('light-theme');
        }

        // Listen for theme changes
        window.addEventListener('storage', (e) => {
            if (e.key === 'theme') {
                if (e.newValue === 'light') {
                    document.body.classList.remove('dark-theme');
                    document.body.classList.add('light-theme');
                } else {
                    document.body.classList.add('dark-theme');
                    document.body.classList.remove('light-theme');
                }
            }
        });

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            initSupabase();
            initializeBookDropdown();
            loadSermons();
            attachDoubleTapListener();
            
            // Hide/show admin buttons based on admin status
            const addBtn = document.getElementById('sermon-add-btn');
            if (addBtn) {
                addBtn.style.display = isAdmin() ? 'flex' : 'none';
            }
            
            // Listen for admin status changes
            window.addEventListener('storage', () => {
                const addBtn = document.getElementById('sermon-add-btn');
                if (addBtn) {
                    addBtn.style.display = isAdmin() ? 'flex' : 'none';
                }
            });
        });

        // Initialize if DOM is already ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                initSupabase();
                if (!bibleMeta) initializeBookDropdown();
                attachDoubleTapListener();
                
                // Hide/show admin buttons based on admin status
                const addBtn = document.getElementById('sermon-add-btn');
                if (addBtn) {
                    addBtn.style.display = isAdmin() ? 'flex' : 'none';
                }
            });
        } else {
            initSupabase();
            initializeBookDropdown();
            loadSermons();
            attachDoubleTapListener();
            
            // Hide/show admin buttons based on admin status
            const addBtn = document.getElementById('sermon-add-btn');
            if (addBtn) {
                addBtn.style.display = isAdmin() ? 'flex' : 'none';
            }
        }
    </script>

    <!-- Passage Popup Modal for verse display -->
    <div class="passage-popup" id="passagePopup" onclick="handlePassagePopupClick(event)">
        <div class="passage-modal-card" id="passageModalCard">
            <div class="passage-header-container">
                <div class="passage-header-handle"></div>
            </div>
            <div class="passage-header" id="passageHeaderDrag">
                <h2 id="passageBadge" class="passage-badge"></h2>
            </div>
            
            <div class="passage-language-buttons">
                <button class="passage-lang-btn" data-lang="tamil" onclick="switchPassageLanguageSermon('tamil')">Tamil</button>
                <button class="passage-lang-btn active" data-lang="english" onclick="switchPassageLanguageSermon('english')">English</button>
                <button class="passage-lang-btn" data-lang="dual" onclick="switchPassageLanguageSermon('dual')">Both</button>
            </div>
            
            <div class="passage-content" id="passageContent"></div>
        </div>
    </div>

    <!-- Fuse.js for smart search (required for passage modal functionality) -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0"></script>
</body>

</html>