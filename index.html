<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <!-- Default light theme colors for status bar -->
    <meta name="theme-color" content="#ffffff" id="theme-color-meta">
    <meta name="color-scheme" content="light" id="color-scheme-meta">
    
    <script>
        // Cache busting - get version from localStorage if available, otherwise use timestamp
        window.CACHE_BUSTER = localStorage.getItem('appVersion') || new Date().getTime();
        
        // Update theme color based on localStorage (overrides default if different)
        const isDarkTheme = localStorage.getItem('theme') !== 'light';
        const themeColorMeta = document.querySelector('meta[name="theme-color"]');
        const colorSchemeMeta = document.querySelector('meta[name="color-scheme"]');
        
        if (themeColorMeta) {
            themeColorMeta.setAttribute('content', isDarkTheme ? '#1e1f22' : '#ffffff');
        }
        if (colorSchemeMeta) {
            colorSchemeMeta.setAttribute('content', isDarkTheme ? 'dark' : 'light');
        }
        
        // Only load manifest on http/https, not file://
        if (window.location.protocol !== 'file:') {
            document.write('<link rel="manifest" href="manifest.json?cb=' + window.CACHE_BUSTER + '">');
        }
    </script>
    <meta name="description" content="Read the Bible in Tamil and Easy English">
    <title>My Bible</title>
    <link rel="icon" type="image/png" href="resources/icons/bible.png?cb=20251126003722">
    <link rel="apple-touch-icon" href="resources/icons/bible.png?cb=20251126003722">
    <link rel="stylesheet" href="src/styles.css?cb=20251210006000">
    <!-- Cache Management -->
    <script src="src/cache-manager.js?cb=20251126003722"></script>
    <script>
        // Apply dark theme class immediately to body for CSS to work
        if (localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark-theme');
        }
    </script>
</head>

<body>
    <header class="top-bar" id="main-header">
        <div class="logo-container">
            <button class="icon-btn menu-btn mobile-only" aria-label="Menu">
                <svg class="hamburger-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
                <svg class="close-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
            <h1 class="site-title">My Bible</h1>
        </div>
        <div class="header-controls">
            <!-- Notes icon (hidden by default) -->
            <button id="notes-icon" class="icon-btn notes-icon" aria-label="Notes" style="display: none;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                    <polyline points="14 2 14 8 20 8" />
                    <line x1="16" y1="13" x2="8" y2="13" />
                    <line x1="16" y1="17" x2="8" y2="17" />
                    <line x1="10" y1="9" x2="8" y2="9" />
                </svg>
            </button>
            <!-- Secret icon (hidden by default) -->
            <button id="secret-icon" class="icon-btn secret-icon" aria-label="Secret" style="display: none;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="none">
                    <path d="M12 2 L15 9 L22 10 L17 15 L18 22 L12 18 L6 22 L7 15 L2 10 L9 9 Z" fill="#FFD700" stroke="#b28b46" stroke-width="1"/>
                </svg>
            </button>
            <!-- Admin toggle button (hidden by default) -->
            <button id="admin-toggle" class="icon-btn admin-toggle" aria-label="Admin Mode" style="display: none;" title="Admin Mode">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                    <path class="admin-check" d="M9 12l2 2 4-4" style="display: none;"/>
                </svg>
            </button>
            <!-- Preload Progress Indicator -->
            <div id="preload-indicator" style="display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.85); color: white; padding: 12px 24px; border-radius: 8px; z-index: 10000; font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <span id="preload-text">Downloading Bible...</span>
                    <span id="preload-progress">0/66</span>
                </div>
            </div>
            <!-- Read Bible button (desktop only, shown on home page) -->
            <button id="read-bible-nav-btn" class="icon-btn read-bible-nav-btn desktop-only" aria-label="Read Bible" title="Read Bible">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                </svg>
            </button>
            <!-- Right Menu button -->
            <button id="right-menu-btn" class="icon-btn right-menu-btn" aria-label="Menu">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="3" width="7" height="7"></rect>
                    <rect x="14" y="3" width="7" height="7"></rect>
                    <rect x="14" y="14" width="7" height="7"></rect>
                    <rect x="3" y="14" width="7" height="7"></rect>
                </svg>
            </button>
            <!-- Search button -->
            <button id="search-btn" class="icon-btn search-btn" aria-label="Search">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"
                    stroke-linecap="round">
                    <circle cx="11" cy="11" r="7"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
            </button>
            <button class="icon-btn lang-btn" aria-label="Language">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="2" y1="12" x2="22" y2="12"></line>
                    <path
                        d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z">
                    </path>
                </svg>
            </button>
            <button class="icon-btn theme-toggle" aria-label="Toggle theme">
                <svg class="sun-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="5" />
                    <line x1="12" y1="1" x2="12" y2="3" />
                    <line x1="12" y1="21" x2="12" y2="23" />
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" />
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" />
                    <line x1="1" y1="12" x2="3" y2="12" />
                    <line x1="21" y1="12" x2="23" y2="12" />
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" />
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" />
                </svg>
                <svg class="moon-icon" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"
                    style="display: none;">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
                </svg>
            </button>
        </div>
    </header>

    <!-- Search Bar (shown below header when active) -->
    <div id="search-bar" class="search-bar" style="display: none;">
        <button id="back-from-search" class="icon-btn back-btn" aria-label="Back">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <line x1="19" y1="12" x2="5" y2="12"></line>
                <polyline points="12 19 5 12 12 5"></polyline>
            </svg>
        </button>
        <div class="search-input-wrapper">
            <svg class="search-input-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2" stroke-linecap="round">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
            </svg>
            <input id="search-input" type="text" class="search-input" placeholder="Search Bible" autocomplete="off">
            <button id="clear-search" class="icon-btn clear-search-btn" aria-label="Clear" style="display: none;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="15" y1="9" x2="9" y2="15"></line>
                    <line x1="9" y1="9" x2="15" y2="15"></line>
                </svg>
            </button>
        </div>
        <div class="filter-btn-wrapper">
            <button id="filter-btn" class="icon-btn filter-btn" aria-label="Filter">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                </svg>
            </button>

            <!-- Advanced Filter Popup -->
            <div id="advanced-filter" class="filter-popup" style="display: none;">
                <div class="filter-popup-content">
                    <div class="filter-popup-header">
                        <h3>Filter Search</h3>
                        <button id="close-filter" class="icon-btn" aria-label="Close">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>
                    <div class="filter-fields">
                        <div class="filter-field">
                            <label for="filter-book">Book</label>
                            <select id="filter-book" class="filter-select">
                                <option value="">All Books</option>
                            </select>
                        </div>
                        <div class="filter-field">
                            <label for="filter-chapter">Chapter</label>
                            <input id="filter-chapter" type="number" class="filter-input" placeholder="Any" min="1">
                        </div>
                    </div>
                    <div class="filter-actions">
                        <button id="clear-filter" class="filter-btn-secondary">Clear</button>
                        <button id="apply-filter" class="filter-btn-primary">Apply</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Language Modal for Mobile -->
    <div class="language-modal-overlay">
        <div class="language-modal">
            <div class="language-modal-header">
                <h3>Select Language</h3>
                <button class="modal-close-btn" aria-label="Close">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="language-modal-options">
                <button class="language-modal-option" data-lang="english">English</button>
                <button class="language-modal-option" data-lang="tamil">Tamil</button>
                <button class="language-modal-option" data-lang="both">Both</button>
            </div>
            <div class="color-palette-section">
                <div class="color-palette-header">
                    <h4>English Text Color</h4>
                </div>
                <div class="color-palette-options">
                    <button class="color-option" data-color="default" aria-label="Default">
                        <div class="color-circle default"></div>
                    </button>
                    <button class="color-option" data-color="blue" aria-label="Blue">
                        <div class="color-circle blue"></div>
                    </button>
                    <button class="color-option" data-color="red" aria-label="Red">
                        <div class="color-circle red"></div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Language Selection Bottom Sheet (Mobile Only) -->
    <div class="language-backdrop" id="language-bottom-sheet-overlay"></div>
    <div class="language-bottom-sheet" id="language-bottom-sheet">
        <div class="language-sheet-handle-bar">
            <div class="language-sheet-handle"></div>
        </div>
        <div class="language-sheet-header">
            <h3>Select Language</h3>
        </div>
        <div class="language-sheet-options">
            <button class="language-sheet-option" data-lang="english">
                <span>English</span>
            </button>
            <button class="language-sheet-option" data-lang="tamil">
                <span>Tamil</span>
            </button>
            <button class="language-sheet-option" data-lang="both">
                <span>Both</span>
            </button>
        </div>
        <div class="language-sheet-color-palette" id="language-sheet-color-palette" style="display: none;">
            <div class="language-sheet-color-header">
                <h4>English Text Color</h4>
            </div>
            <div class="language-sheet-color-options">
                <button class="language-sheet-color-option" data-color="default" aria-label="Default">
                    <div class="color-circle default"></div>
                </button>
                <button class="language-sheet-color-option" data-color="blue" aria-label="Blue">
                    <div class="color-circle blue"></div>
                </button>
                <button class="language-sheet-color-option" data-color="red" aria-label="Red">
                    <div class="color-circle red"></div>
                </button>
            </div>
        </div>
    </div>

    <!-- Note Viewer Modal -->
    <div class="note-viewer-overlay" id="note-viewer-popup" style="display: none;">
        <div class="note-viewer-modal">
            <div class="note-viewer-handle">
                <div class="note-viewer-handle-bar"></div>
            </div>
            <div class="note-viewer-header">
                <span class="note-viewer-ref" id="note-viewer-ref"></span>
                
                <!-- Single Title (shown when tabs are hidden) -->
                <div class="note-viewer-single-title" id="note-viewer-single-title" style="display: none;"></div>
                
                <!-- Segmented Control in Header -->
                <div class="note-viewer-tabs">
                    <button class="note-viewer-tab active" data-tab="note" onclick="switchNoteViewerTab('note')" title="Note">
                        <img src="resources/icons/note.png" alt="Note" class="note-viewer-tab-icon">
                    </button>
                    <button class="note-viewer-tab" data-tab="references" onclick="switchNoteViewerTab('references')" style="display: none;" title="References">
                        <svg class="note-viewer-tab-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                            <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                        </svg>
                    </button>
                </div>
                
                <button class="note-viewer-close-btn" id="note-viewer-close-btn" title="Close">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            
            <!-- Tab Content -->
            <div class="note-viewer-tab-content active" id="note-tab-content">
                <div class="note-viewer-section">
                    <div class="note-viewer-content" id="note-viewer-content"></div>
                </div>
                <button class="note-viewer-edit-btn" id="note-viewer-edit-btn" title="Edit Note">
                    Edit
                </button>
            </div>
            
            <div class="note-viewer-tab-content" id="references-tab-content">
                <div class="note-viewer-references-content" id="note-viewer-references-content"></div>
                <button class="note-viewer-add-ref-btn" id="note-viewer-add-ref-btn" title="Add Reference" onclick="showAddReferenceDialog()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                </button>
            </div>
            
            <div class="note-viewer-footer">
            </div>
        </div>
    </div>

    <!-- Passage Popup for Note Viewer -->
    <div class="passage-popup" id="notePassagePopup" onclick="handleNotePassagePopupClick(event)">
        <div class="passage-modal-card" onclick="event.stopPropagation()">
            <div class="passage-header-handle-container">
                <div class="passage-header-handle"></div>
            </div>
            <div class="passage-modal-header">
                <h2 class="passage-modal-title">
                    <span class="passage-modal-badge" id="notePassageBadge">Loading...</span>
                </h2>
                <button class="passage-modal-close-btn" onclick="closeNotePassageModal()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="passage-modal-lang-buttons">
                <button class="passage-lang-btn active" data-lang="english" onclick="switchNotePassageLanguage('english')">English</button>
                <button class="passage-lang-btn" data-lang="tamil" onclick="switchNotePassageLanguage('tamil')">Tamil</button>
                <button class="passage-lang-btn" data-lang="dual" onclick="switchNotePassageLanguage('dual')">Both</button>
            </div>
            <div class="passage-modal-content" id="notePassageContent">
                <p>Loading passage...</p>
            </div>
        </div>
    </div>

    <!-- Add Reference Bottom Sheet -->
    <div class="add-ref-sheet-overlay" id="add-ref-sheet-overlay"></div>
    <div class="add-ref-sheet" id="add-ref-sheet">
        <div class="add-ref-sheet-handle"></div>
        <div class="add-ref-sheet-header">
            <h2 class="add-ref-sheet-title">Add Reference</h2>
            <button class="add-ref-close-btn" id="add-ref-close-btn" aria-label="Close">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="add-ref-sheet-content">
            <div class="add-ref-input-group">
                <div class="add-ref-dropdowns-container">
                    <div class="add-ref-dropdowns-row">
                        <div class="add-ref-dropdown-group">
                            <label class="add-ref-dropdown-label">Book</label>
                            <select class="add-ref-dropdown-select" id="add-ref-book-select">
                                <option value="">Select Book</option>
                            </select>
                        </div>
                        <div class="add-ref-dropdown-group">
                            <label class="add-ref-dropdown-label">Chapter</label>
                            <select class="add-ref-dropdown-select" id="add-ref-chapter-select" disabled>
                                <option value="">Select Chapter</option>
                            </select>
                        </div>
                    </div>
                    <div class="add-ref-verses-row">
                        <div class="add-ref-dropdown-group">
                            <label class="add-ref-dropdown-label">Verses</label>
                            <select class="add-ref-dropdown-select" id="add-ref-verses-select" multiple disabled>
                                <option value="" disabled>Select Verse</option>
                            </select>
                        </div>
                        <button class="add-ref-add-verse-btn" id="add-ref-add-verse-btn" type="button" disabled>Add Verse</button>
                    </div>
                </div>
                <div class="add-ref-verses-chips" id="add-ref-verses-chips"></div>
            </div>
            
            <!-- Section showing existing references -->
            <div class="add-ref-existing-refs" id="add-ref-existing-refs">
                <div class="add-ref-existing-label">Current References:</div>
                <div class="add-ref-existing-list" id="add-ref-existing-list"></div>
            </div>
        </div>
        <div class="add-ref-sheet-buttons">
            <button class="add-ref-btn add-ref-btn-cancel" id="add-ref-btn-cancel">Cancel</button>
            <button class="add-ref-btn add-ref-btn-save" id="add-ref-btn-save">Save</button>
        </div>
    </div>

    <!-- Notes Modal with Android-style Bottom Sheet -->
    <div class="notes-modal-overlay" id="notes-modal-overlay" style="display: none;">
        <div class="notes-modal" id="notes-modal">
            <!-- Handle bar for drag gesture (Android-style) -->
            <div class="notes-sheet-handle" id="notes-sheet-drag-handle">
                <div class="notes-handle-bar"></div>
            </div>
            
            <div class="notes-modal-header">
                <h3>Add Note</h3>
                <button class="notes-modal-close-btn" aria-label="Close">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            
            <div class="notes-modal-content" id="notes-modal-content">
                <div class="notes-verse-ref-wrapper">
                    <div class="notes-verse-ref" id="notes-verse-ref"></div>
                </div>
                <div id="notes-textarea" class="notes-textarea" contenteditable="true" data-placeholder="Type your note here..."></div>
                <div class="notes-modal-actions">
                    <button id="delete-note-btn" class="notes-btn-delete" style="display: none;">Delete</button>
                    <button id="save-note-btn" class="notes-btn-save">Save Note</button>
                </div>
            </div>
            
            <!-- Loading Overlay -->
            <div class="notes-loading" id="notes-loading">
                <div class="notes-spinner"></div>
            </div>
        </div>
    </div>

    <!-- Bookmark Color Picker Bottom Sheet -->
    <div class="bookmark-color-picker-overlay" id="bookmark-color-picker-overlay">
        <div class="bookmark-color-picker-sheet">
            <!-- Handle bar for drag gesture -->
            <div class="bookmark-color-sheet-handle" id="bookmark-color-sheet-handle">
                <div class="bookmark-color-handle-bar"></div>
            </div>
            
            <div class="bookmark-color-sheet-header">
                <h3>Select Bookmark Color</h3>
                <button class="bookmark-color-close-btn" id="bookmark-color-close-btn" aria-label="Close">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            
            <div class="bookmark-color-sheet-content" id="bookmark-color-sheet-content">
                <div class="bookmark-color-options-grid">
                    <button class="bookmark-color-option" data-color="burgundy" style="background: #78aaff !important;" title="Blue"></button>
                    <button class="bookmark-color-option" data-color="forest" style="background: #e6c45a !important;" title="Gold"></button>
                    <button class="bookmark-color-option" data-color="navy" style="background: #72e6a4 !important;" title="Mint"></button>
                    <button class="bookmark-color-option" data-color="amber" style="background: #ff8fc1 !important;" title="Rose"></button>
                    <button class="bookmark-color-option" data-color="violet" style="background: #ff9a54 !important;" title="Orange"></button>
                    <button class="bookmark-color-option" data-color="teal" style="background: #b38aff !important;" title="Purple"></button>
                    <button class="bookmark-color-option" data-color="rust" style="background: #5ed0d9 !important;" title="Teal"></button>
                    <button class="bookmark-color-option" data-color="olive" style="background: #ff7a7a !important;" title="Red"></button>
                    <button class="bookmark-color-option" data-color="indigo" style="background: #b4c76f !important;" title="Olive"></button>
                    <button class="bookmark-color-option" data-color="slate" style="background: #9d9d9d !important;" title="Grey"></button>
                    <button class="bookmark-color-option" data-color="yellow" style="background: #78aaff !important;" title="Blue"></button>
                    <button class="bookmark-color-option" data-color="green" style="background: #e6c45a !important;" title="Gold"></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Voice Command Status -->
    <div id="voice-status" class="voice-status" style="display: none;">
        <div class="voice-status-content">
            <svg class="voice-status-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                <line x1="12" y1="19" x2="12" y2="23"></line>
                <line x1="8" y1="23" x2="16" y2="23"></line>
            </svg>
            <span class="voice-status-text">Listening...</span>
        </div>
    </div>

    <div class="main-layout">
        <!-- Mobile Drawer Overlay -->
        <div class="drawer-overlay"></div>

        <!-- Mobile Drawer Header -->
        <div class="drawer-header">
            <button class="drawer-close-btn" aria-label="Close">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
            <span class="drawer-title">My Bible</span>
            <div class="drawer-header-controls">
                <button class="icon-btn drawer-search-btn" aria-label="Search">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round">
                        <circle cx="11" cy="11" r="8" />
                        <path d="M21 21l-4.35-4.35" />
                    </svg>
                </button>
                <button class="icon-btn drawer-theme-toggle" aria-label="Toggle theme">
                    <svg class="sun-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5" />
                        <line x1="12" y1="1" x2="12" y2="3" />
                        <line x1="12" y1="21" x2="12" y2="23" />
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" />
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" />
                        <line x1="1" y1="12" x2="3" y2="12" />
                        <line x1="21" y1="12" x2="23" y2="12" />
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" />
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" />
                    </svg>
                    <svg class="moon-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- Left Sidebar - Books -->
        <aside class="books-sidebar">
            <div class="book-item active">
                <span class="book-name">Genesis</span>
            </div>
            <div class="book-item">
                <span class="book-name">Exodus</span>
            </div>
            <div class="book-item">
                <span class="book-name">Leviticus</span>
            </div>
            <div class="book-item">
                <span class="book-name">Numbers</span>
            </div>
            <div class="book-item">
                <span class="book-name">Deuteronomy</span>
            </div>
            <div class="book-item">
                <span class="book-name">Joshua</span>
            </div>
            <div class="book-item">
                <span class="book-name">Judges</span>
            </div>
            <div class="book-item">
                <span class="book-name">Ruth</span>
            </div>
            <div class="book-item">
                <span class="book-name">I Samuel</span>
            </div>
            <div class="book-item">
                <span class="book-name">II Samuel</span>
            </div>
            <div class="book-item">
                <span class="book-name">I Kings</span>
            </div>
            <div class="book-item">
                <span class="book-name">II Kings</span>
            </div>
            <div class="book-item">
                <span class="book-name">I Chronicles</span>
            </div>
            <div class="book-item">
                <span class="book-name">II Chronicles</span>
            </div>
            <div class="book-item">
                <span class="book-name">Ezra</span>
            </div>
            <div class="book-item">
                <span class="book-name">Nehemiah</span>
            </div>
            <div class="book-item">
                <span class="book-name">Esther</span>
            </div>
            <div class="book-item">
                <span class="book-name">Job</span>
            </div>
            <div class="book-item">
                <span class="book-name">Psalms</span>
            </div>
            <div class="book-item">
                <span class="book-name">Proverbs</span>
            </div>
            <div class="book-item">
                <span class="book-name">Ecclesiastes</span>
            </div>
            <div class="book-item">
                <span class="book-name">Song of Solomon</span>
            </div>
            <div class="book-item">
                <span class="book-name">Isaiah</span>
            </div>
            <div class="book-item">
                <span class="book-name">Jeremiah</span>
            </div>
            <div class="book-item">
                <span class="book-name">Lamentations</span>
            </div>
            <div class="book-item">
                <span class="book-name">Ezekiel</span>
            </div>
            <div class="book-item">
                <span class="book-name">Daniel</span>
            </div>
            <div class="book-item">
                <span class="book-name">Hosea</span>
            </div>
            <div class="book-item">
                <span class="book-name">Joel</span>
            </div>
            <div class="book-item">
                <span class="book-name">Amos</span>
            </div>
            <div class="book-item">
                <span class="book-name">Obadiah</span>
            </div>
            <div class="book-item">
                <span class="book-name">Jonah</span>
            </div>
            <div class="book-item">
                <span class="book-name">Micah</span>
            </div>
            <div class="book-item">
                <span class="book-name">Nahum</span>
            </div>
            <div class="book-item">
                <span class="book-name">Habakkuk</span>
            </div>
            <div class="book-item">
                <span class="book-name">Zephaniah</span>
            </div>
            <div class="book-item">
                <span class="book-name">Haggai</span>
            </div>
            <div class="book-item">
                <span class="book-name">Zechariah</span>
            </div>
            <div class="book-item">
                <span class="book-name">Malachi</span>
            </div>
            <div class="book-item">
                <span class="book-name">Matthew</span>
            </div>
            <div class="book-item">
                <span class="book-name">Mark</span>
            </div>
            <div class="book-item">
                <span class="book-name">Luke</span>
            </div>
            <div class="book-item">
                <span class="book-name">John</span>
            </div>
            <div class="book-item">
                <span class="book-name">Acts</span>
            </div>
            <div class="book-item">
                <span class="book-name">Romans</span>
            </div>
            <div class="book-item">
                <span class="book-name">I Corinthians</span>
            </div>
            <div class="book-item">
                <span class="book-name">II Corinthians</span>
            </div>
            <div class="book-item">
                <span class="book-name">Galatians</span>
            </div>
            <div class="book-item">
                <span class="book-name">Ephesians</span>
            </div>
            <div class="book-item">
                <span class="book-name">Philippians</span>
            </div>
            <div class="book-item">
                <span class="book-name">Colossians</span>
            </div>
            <div class="book-item">
                <span class="book-name">I Thessalonians</span>
            </div>
            <div class="book-item">
                <span class="book-name">II Thessalonians</span>
            </div>
            <div class="book-item">
                <span class="book-name">I Timothy</span>
            </div>
            <div class="book-item">
                <span class="book-name">II Timothy</span>
            </div>
            <div class="book-item">
                <span class="book-name">Titus</span>
            </div>
            <div class="book-item">
                <span class="book-name">Philemon</span>
            </div>
            <div class="book-item">
                <span class="book-name">Hebrews</span>
            </div>
            <div class="book-item">
                <span class="book-name">James</span>
            </div>
            <div class="book-item">
                <span class="book-name">I Peter</span>
            </div>
            <div class="book-item">
                <span class="book-name">II Peter</span>
            </div>
            <div class="book-item">
                <span class="book-name">I John</span>
            </div>
            <div class="book-item">
                <span class="book-name">II John</span>
            </div>
            <div class="book-item">
                <span class="book-name">III John</span>
            </div>
            <div class="book-item">
                <span class="book-name">Jude</span>
            </div>
            <div class="book-item">
                <span class="book-name">Revelation</span>
            </div>
        </aside>

        <!-- Middle Column - Chapters -->
        <aside class="chapters-column">
            <div class="number-item active">1</div>
            <div class="number-item">2</div>
            <div class="number-item">3</div>
            <div class="number-item">4</div>
            <div class="number-item">5</div>
            <div class="number-item">6</div>
            <div class="number-item">7</div>
            <div class="number-item">8</div>
            <div class="number-item">9</div>
            <div class="number-item">10</div>
            <div class="number-item">11</div>
            <div class="number-item">12</div>
            <div class="number-item">13</div>
            <div class="number-item">14</div>
            <div class="number-item">15</div>
            <div class="number-item">16</div>
            <div class="number-item">17</div>
            <div class="number-item">18</div>
            <div class="number-item">19</div>
            <div class="number-item">20</div>
            <div class="number-item">21</div>
            <div class="number-item">22</div>
        </aside>

        <!-- Verses Column -->
        <aside class="verses-column">
            <div class="number-item active">1</div>
            <div class="number-item">2</div>
            <div class="number-item">3</div>
            <div class="number-item">4</div>
            <div class="number-item">5</div>
            <div class="number-item">6</div>
            <div class="number-item">7</div>
            <div class="number-item">8</div>
            <div class="number-item">9</div>
            <div class="number-item">10</div>
            <div class="number-item">11</div>
            <div class="number-item">12</div>
            <div class="number-item">13</div>
            <div class="number-item">14</div>
            <div class="number-item">15</div>
            <div class="number-item">16</div>
            <div class="number-item">17</div>
            <div class="number-item">18</div>
            <div class="number-item">19</div>
            <div class="number-item">20</div>
            <div class="number-item">21</div>
            <div class="number-item">22</div>
        </aside>

        <!-- Verse Count Bookmark -->
        <div class="verse-count-banner-container" id="verse-count-banner">
            <span class="verse-count-text"></span>
        </div>

        <!-- Main Content Area -->
        <main class="content-area">
            <!-- Loading Spinner -->
            <div class="loader-overlay" id="loader">
                <div class="loader-container">
                    <div class="book-loader"></div>
                    <p class="loader-text">Loading...</p>
                </div>
            </div>

            <!-- Search Results Info -->
            <div id="search-results-info" class="search-results-info" style="display: none;">
                Found <span id="results-count">0</span> results
            </div>

            <!-- Search Results -->
            <div id="search-results" class="search-results" style="display: none;">
                <div class="search-empty-state">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"
                        stroke-linecap="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    <p>Search for verses in Tamil or English</p>
                </div>
            </div>

            <!-- Scripture Text (Bible Content) -->
            <!-- Mobile Chapter Header -->
            <div class="mobile-chapter-header" id="mobile-chapter-header">
                <div class="mobile-chapter-title"></div>
                <div class="mobile-chapter-number-wrapper">
                    <div class="mobile-chapter-number"></div>
                    <span class="mobile-verse-count-badge" id="mobile-verse-count-badge"></span>
                    <button class="expand-all-headers-btn" id="expand-all-headers-btn" title="Expand/collapse all headers">
                        <span class="expand-all-icon">‚áÖ</span>
                    </button>
                </div>
            </div>
            
            <div class="scripture-text" id="scripture-text"></div>
        </main>
    </div>

    <!-- Right Sidebar - Menu Options -->
    <aside class="right-sidebar">
        <div class="right-menu-item" id="bible-reading-option">
            <span class="option-icon" style="font-size: 20px;">üìö</span>
            <span class="option-name">Bible Reading</span>
        </div>
        <div class="right-menu-item" id="right-notes-option">
            <span class="option-icon" style="font-size: 20px;">üìù</span>
            <span class="option-name">Bible Notes</span>
        </div>
        <div class="right-menu-item" id="right-cult-option">
            <span class="option-icon" style="font-size: 20px;">‚ö†Ô∏è</span>
            <span class="option-name">WMSCOG Cult</span>
        </div>
        <div class="right-menu-item" id="right-kings-option" style="display: none;">
            <span class="option-icon" style="font-size: 20px;">üëë</span>
            <span class="option-name">Kings</span>
        </div>
        <div class="right-menu-item" id="right-prophets-option" style="display: none;">
            <span class="option-icon" style="font-size: 20px;">üïäÔ∏è</span>
            <span class="option-name">Prophets</span>
        </div>
        <div class="right-menu-item" id="right-timeline-option" style="display: none;">
            <span class="option-icon" style="font-size: 20px;">‚è≥</span>
            <span class="option-name">Timeline</span>
        </div>
        <div class="right-menu-item" id="right-character-option">
            <span class="option-icon" style="font-size: 20px;">‚ú®</span>
            <span class="option-name">Character Study</span>
        </div>
        <div class="right-menu-item" id="right-life-of-jesus-option">
            <svg class="option-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2v20M5 8h14"/>
            </svg>
            <span class="option-name">Life of Jesus</span>
        </div>
        <div class="right-menu-item" id="right-sermon-option">
            <span class="option-icon" style="font-size: 20px;">üéôÔ∏è</span>
            <span class="option-name">Sermons</span>
        </div>
        <div class="right-menu-item" id="right-prayers-option">
            <span class="option-icon" style="font-size: 20px;">üôè</span>
            <span class="option-name">Prayers</span>
        </div>
    </aside>

    <!-- Summary Drawer -->
    <div class="summary-drawer" id="summary-drawer">
        <div class="summary-drawer-header">
            <h3 class="summary-drawer-title">Chapter Summary</h3>
            <button class="close-summary-btn" id="close-summary-btn" aria-label="Close">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="summary-drawer-content" id="summary-drawer-content">
        </div>
    </div>
    <div class="summary-drawer-overlay" id="summary-drawer-overlay"></div>

    <!-- Bottom Navigation Bar -->
    <nav class="bottom-nav">
        <button class="nav-btn" aria-label="Previous">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M19 12H5M12 19l-7-7 7-7" />
            </svg>
        </button>

        <div class="current-chapter">Genesis 1</div>

        <div class="home-wrapper">
            <!-- Home Options Card -->
            <div class="home-options-card" id="home-options-card">
                <div class="home-option" data-action="summary">
                    <svg class="option-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                        <polyline points="14 2 14 8 20 8" />
                        <line x1="16" y1="13" x2="8" y2="13" />
                        <line x1="16" y1="17" x2="8" y2="17" />
                        <polyline points="10 9 9 9 8 9" />
                    </svg>
                    <span>Chapter Summary</span>
                </div>
                <div class="home-option" data-action="timeline">
                    <svg class="option-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10" />
                        <polyline points="12 6 12 12 16 14" />
                    </svg>
                    <span>Chapter Timeline</span>
                </div>
                <div class="home-option" data-action="characters">
                    <svg class="option-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                        <circle cx="9" cy="7" r="4" />
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
                        <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                    </svg>
                    <span>Chapter Characters</span>
                </div>
            </div>
            
            <button class="nav-btn home-btn" aria-label="Home" style="display: none;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
                    <polyline points="9 22 9 12 15 12 15 22" />
                </svg>
            </button>
        </div>

        <button id="search-btn-mobile" class="nav-btn mobile-only" aria-label="Search">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                stroke-linecap="round">
                <circle cx="11" cy="11" r="7"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
        </button>

        <button id="pinned-verses-btn" class="nav-btn" aria-label="Pinned Verses" title="Pinned Verses">
            <span style="font-size: 20px;">üìå</span>
            <span class="pinned-verses-badge" id="pinned-verses-badge" style="display: none;">0</span>
        </button>

        <button id="voice-btn" class="nav-btn voice-btn" aria-label="Voice Command" title="Voice Command">
            <svg class="mic-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                <line x1="12" y1="19" x2="12" y2="23"></line>
                <line x1="8" y1="23" x2="16" y2="23"></line>
            </svg>
            <svg class="mic-listening-icon" width="20" height="20" viewBox="0 0 24 24" fill="#ff4444" stroke="#ff4444" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                <line x1="12" y1="19" x2="12" y2="23"></line>
                <line x1="8" y1="23" x2="16" y2="23"></line>
            </svg>
        </button>

        <button class="nav-btn" aria-label="Next">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M5 12h14M12 5l7 7-7 7" />
            </svg>
        </button>
    </nav>

    <!-- Gesture Navigation Area (for mobile devices with gesture navigation) -->
    <div class="gesture-nav-area"></div>

    <!-- Bible Reading Page -->
    <div id="bible-reading-page" class="bible-reading-page" style="display: none;">
        <header class="bible-reading-header">
            <button id="exit-bible-reading" class="icon-btn exit-btn" aria-label="Exit">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="19" y1="12" x2="5" y2="12"></line>
                    <polyline points="12 19 5 12 12 5"></polyline>
                </svg>
            </button>
            <h2 class="bible-reading-title">Bible Reading</h2>
        </header>
        <div class="bible-reading-content">
            <!-- Content will be added here in the future -->
        </div>
    </div>

    <!-- Cross Reference Bottom Sheet -->
    <div class="cross-ref-sheet-overlay" id="cross-ref-sheet-overlay"></div>
    <div class="cross-ref-detail-sheet" id="cross-ref-detail-sheet">
        <div class="cross-ref-sheet-handle"></div>
        <div class="cross-ref-sheet-header detail-header" id="cross-ref-detail-header">
            <h2 class="cross-ref-sheet-title">Cross References</h2>
            <button class="cross-ref-detail-close-btn" id="cross-ref-detail-close-btn" aria-label="Close">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="width: 100%; height: 100%;">
                    <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
            </button>
        </div>
        
        <div class="cross-ref-language-buttons">
            <button class="cross-ref-lang-btn" data-lang="tamil" onclick="switchCrossRefLanguage('tamil')">Tamil</button>
            <button class="cross-ref-lang-btn active" data-lang="english" onclick="switchCrossRefLanguage('english')">English</button>
            <button class="cross-ref-lang-btn" data-lang="dual" onclick="switchCrossRefLanguage('dual')">Both</button>
        </div>
        
        <div class="cross-ref-sheet-content" id="cross-ref-detail-content"></div>
    </div>

    <!-- Bundled Bible Data (loads all books) -->
    <script src="data/bible/bible-data-loader.js?cb=20251126003722"></script>
    
    <!-- Supabase Client Library (Local for Offline Support) -->
    <script src="src/lib/supabase.js?cb=20251126003722"></script>
    
    <!-- Supabase Integrations -->
    <script src="src/lib/supabase-pinned-verses.js?cb=20251126003722"></script>
    
    <script src="config/config.js?cb=20251126003722"></script>
    <script src="src/bible-data-manager.js?cb=20251126003722"></script>
    <script src="src/voice-command.js?cb=20251126003722"></script>
    <script src="src/data/verse-headers.js?cb=20251126003722"></script>
    <script src="src/data/bible-meta.js?cb=20251210006100"></script>
    <script src="src/script.js?cb=20251210007400"></script>

    <!-- Image Viewer Modal -->
    <style>
        #viewer {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .95);
            z-index: 9999;
            display: none;
            flex-direction: column;
            overscroll-behavior: contain;
            touch-action: none;
        }

        #viewer.open {
            display: flex;
        }

        /* Hide zoom control buttons - zoom available via keyboard/mouse wheel only */
        .viewer-zoom-btn,
        .viewer-zoom-info,
        .viewer-controls-divider {
            display: none !important;
        }

        .viewer-topbar {
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 16px;
            padding: 0 14px;
            color: #fff;
            font-size: 18px;
            user-select: none;
            order: 2;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: linear-gradient(to top, rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.2));
            pointer-events: auto;
            z-index: 10001;
        }

        .viewer-btn {
            cursor: pointer;
            opacity: .8;
            transition: opacity 0.2s ease;
        }

        .viewer-btn:hover {
            opacity: 1;
        }

        .viewer-stage {
            flex: 1;
            overflow: hidden;
            position: relative;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
            order: 1;
            cursor: pointer;
            pointer-events: auto;
        }

        .viewer-img {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(1);
            transform-origin: center;
            max-width: 100%;
            max-height: 100%;
            user-select: none;
            cursor: grab;
            pointer-events: auto;
        }

        .viewer-img:active {
            cursor: grabbing;
        }

        .viewer-zoom-btn {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.15);
            border: 1.5px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            user-select: none;
        }

        .viewer-zoom-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .viewer-zoom-btn:active {
            transform: scale(0.95);
        }

        .viewer-zoom-info {
            color: #fff;
            font-size: 14px;
            font-weight: 600;
            min-width: 50px;
            text-align: center;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .viewer-zoom-info.show {
            opacity: 1;
        }

        .viewer-controls-divider {
            width: 1px;
            height: 24px;
            background: rgba(255, 255, 255, 0.2);
        }

        .viewer-close-btn {
            width: 40px;
            height: 40px;
            background: rgba(255, 100, 100, 0.2);
            border: 1.5px solid rgba(255, 100, 100, 0.4);
            border-radius: 8px;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            user-select: none;
            pointer-events: auto;
            z-index: 10001;
        }

        .viewer-close-btn:hover {
            background: rgba(255, 100, 100, 0.35);
            border-color: rgba(255, 100, 100, 0.6);
        }

        .viewer-close-btn:active {
            transform: scale(0.95);
        }
    </style>

    <div id="viewer">
        <div class="viewer-stage" id="stage">
            <img id="viewerImg" class="viewer-img">
        </div>
        <div class="viewer-topbar">
            <span class="viewer-close-btn" onclick="closeViewer()">‚úï</span>
        </div>
    </div>

    <script>
        let scale = 1;
        let posX = 0, posY = 0;
        let startX = 0, startY = 0;
        let isDragging = false;
        let lastTouchDist = 0;
        let touchStartX = 0, touchStartY = 0;
        let scrollPosition = 0;
        const img = document.getElementById('viewerImg');
        const stage = document.getElementById('stage');
        const viewer = document.getElementById('viewer');
        let viewerIsOpen = false;

        function openViewer(imageSrc) {
            // Save current scroll position
            scrollPosition = window.scrollY || document.documentElement.scrollTop;
            
            img.src = imageSrc;
            viewer.classList.add('open');
            viewerIsOpen = true;
            // Reset zoom to 100%
            resetZoom();
            // Disable background scrolling
            document.body.style.overflow = 'hidden';
            document.documentElement.style.overflow = 'hidden';
            
            // Push a history state for the image viewer
            // This way, back button will close the image first
            history.pushState({ type: 'imageViewer', open: true }, '', window.location.href);
        }

        function closeViewer() {
            viewer.classList.remove('open');
            viewerIsOpen = false;
            // Re-enable background scrolling
            document.body.style.overflow = '';
            document.documentElement.style.overflow = '';
            // Restore scroll position
            window.scrollTo(0, scrollPosition);
            
            // Pop the history state if viewer was open
            if (history.state && history.state.type === 'imageViewer') {
                history.back();
            }
        }

        function updateTransform() {
            img.style.transform = `translate(calc(-50% + ${posX}px), calc(-50% + ${posY}px)) scale(${scale})`;
        }

        function zoomIn() {
            scale *= 1.2;
            updateTransform();
        }

        function zoomOut() {
            scale = Math.max(1, scale / 1.2);
            updateTransform();
        }

        function resetZoom() {
            scale = 1;
            posX = 0;
            posY = 0;
            updateTransform();
        }

        // Close when clicking outside the image
        stage.addEventListener('click', e => {
            // Don't close if clicking on the image itself
            if (e.target === img) {
                return;
            }
            // Close if clicking anywhere else on the stage (dark background)
            closeViewer();
        });

        // Additional handler for clicks directly on viewer div
        viewer.addEventListener('click', e => {
            // Close if clicking on the viewer container itself (dark background)
            // But not on the close button (handled separately by onclick)
            if (e.target === viewer && viewerIsOpen) {
                closeViewer();
            }
        }, true);

        // Handle back button/swipe - close image first, then allow app navigation
        window.addEventListener('popstate', e => {
            // If image viewer is open, close it instead of going back
            if (viewerIsOpen) {
                // Close image without popping history again
                viewer.classList.remove('open');
                viewerIsOpen = false;
                document.body.style.overflow = '';
                document.documentElement.style.overflow = '';
                window.scrollTo(0, scrollPosition);
                // Push state back so back button can work again after image closes
                history.pushState({ type: 'imageViewer', open: true }, '', window.location.href);
            }
        }, false);

        // Block back swipe gesture when viewer is open
        document.addEventListener('touchstart', e => {
            if (viewerIsOpen && e.touches.length === 1) {
                const touchX = e.touches[0].clientX;
                // Block swipes from left edge (back swipe) when viewer is open
                if (touchX < 50) {
                    e.preventDefault();
                }
            }
        }, { passive: false });

        document.addEventListener('touchmove', e => {
            if (viewerIsOpen && e.touches.length === 1) {
                const touchX = e.touches[0].clientX;
                // Continue blocking left edge swipes
                if (touchX < 50) {
                    e.preventDefault();
                }
            }
        }, { passive: false });

        // Keyboard shortcuts for zoom (hidden UI, accessible via keyboard)
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') closeViewer();
            if (e.key === '+' || e.key === '=') zoomIn();
            if (e.key === '-') zoomOut();
            if (e.key === '0') resetZoom();
        });

        // Mouse wheel zoom
        stage.addEventListener('wheel', e => {
            e.preventDefault();
            if (e.deltaY < 0) zoomIn();
            else zoomOut();
        }, { passive: false });

        // Double-click to toggle zoom
        stage.addEventListener('dblclick', e => {
            if (e.target !== img) return;
            if (scale === 1) scale = 2.5;
            else resetZoom();
            updateTransform();
        });

        // Mouse drag when zoomed
        stage.addEventListener('mousedown', e => {
            if (scale <= 1) return;
            isDragging = true;
            startX = e.clientX - posX;
            startY = e.clientY - posY;
            e.preventDefault();
        });

        window.addEventListener('mousemove', e => {
            if (!isDragging) return;
            posX = e.clientX - startX;
            posY = e.clientY - startY;
            updateTransform();
        });

        window.addEventListener('mouseup', () => isDragging = false);

        // Touch support: pinch-to-zoom and drag-to-pan
        stage.addEventListener('touchstart', e => {
            if (e.touches.length === 2) {
                // Pinch zoom start
                lastTouchDist = Math.hypot(
                    e.touches[0].clientX - e.touches[1].clientX,
                    e.touches[0].clientY - e.touches[1].clientY
                );
                e.preventDefault();
            } else if (e.touches.length === 1 && scale > 1) {
                // Single finger drag when zoomed
                isDragging = true;
                touchStartX = e.touches[0].clientX - posX;
                touchStartY = e.touches[0].clientY - posY;
                e.preventDefault();
            } else if (e.touches.length === 1) {
                // Block swipe-back at left edge even when not zoomed
                e.preventDefault();
            }
        }, { passive: false });

        stage.addEventListener('touchmove', e => {
            // Only prevent default if we're doing something with the image (pinch or drag)
            if (e.touches.length === 2 || (e.touches.length === 1 && isDragging && scale > 1)) {
                e.preventDefault();
            }
            
            if (e.touches.length === 2) {
                // Pinch zoom
                const newDist = Math.hypot(
                    e.touches[0].clientX - e.touches[1].clientX,
                    e.touches[0].clientY - e.touches[1].clientY
                );
                if (lastTouchDist > 0) {
                    scale *= newDist / lastTouchDist;
                    scale = Math.max(1, Math.min(scale, 5)); // Limit zoom between 1x and 5x
                    updateTransform();
                }
                lastTouchDist = newDist;
            } else if (e.touches.length === 1 && isDragging && scale > 1) {
                // Single finger drag when zoomed
                posX = e.touches[0].clientX - touchStartX;
                posY = e.touches[0].clientY - touchStartY;
                updateTransform();
            }
        }, { passive: false });

        stage.addEventListener('touchend', e => {
            isDragging = false;
            lastTouchDist = 0;
            if (e.touches.length === 0) {
                e.preventDefault();
            }
        }, { passive: false });

        // Only intercept specific swipe gestures when viewer is open to prevent app navigation
        document.addEventListener('touchstart', e => {
            // Only prevent default for potential swipe-back gestures at left edge
            if (viewerIsOpen && e.touches.length === 1) {
                const touchX = e.touches[0].clientX;
                if (touchX < 30) {
                    e.preventDefault();
                }
            }
        }, { passive: false });

        // Prevent scrolling gestures that aren't on the viewer stage
        document.addEventListener('touchmove', e => {
            // Only prevent if viewer is open and touch is not within stage
            if (viewerIsOpen && !stage.contains(e.target)) {
                e.preventDefault();
            }
        }, { passive: false });
    </script>

    <script>
        // Mobile search button handler
        document.addEventListener('DOMContentLoaded', () => {
            const searchBtnMobile = document.getElementById('search-btn-mobile');
            const searchBtn = document.getElementById('search-btn');
            if (searchBtnMobile && searchBtn) {
                searchBtnMobile.addEventListener('click', () => {
                    searchBtn.click();
                });
            }
        });
    </script>
</body>

</html>